var ke=Object.defineProperty,Ee=Object.defineProperties;var Ce=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var Te=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable;var ee=(o,e,t)=>e in o?ke(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,S=(o,e)=>{for(var t in e||(e={}))Te.call(e,t)&&ee(o,t,e[t]);if(Z)for(var t of Z(e))Pe.call(e,t)&&ee(o,t,e[t]);return o},M=(o,e)=>Ee(o,Ce(e));var l=(o,e,t)=>new Promise((i,s)=>{var n=c=>{try{a(t.next(c))}catch(d){s(d)}},r=c=>{try{a(t.throw(c))}catch(d){s(d)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(n,r);a((t=t.apply(o,e)).next())});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const k=Object.create(null);k.open="0";k.close="1";k.ping="2";k.pong="3";k.message="4";k.upgrade="5";k.noop="6";const _=Object.create(null);Object.keys(k).forEach(o=>{_[k[o]]=o});const z={type:"error",data:"parser error"},ce=typeof Blob=="function"||typeof Blob!="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",le=typeof ArrayBuffer=="function",de=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o&&o.buffer instanceof ArrayBuffer,Q=({type:o,data:e},t,i)=>ce&&e instanceof Blob?t?i(e):te(e,i):le&&(e instanceof ArrayBuffer||de(e))?t?i(e):te(new Blob([e]),i):i(k[o]+(e||"")),te=(o,e)=>{const t=new FileReader;return t.onload=function(){const i=t.result.split(",")[1];e("b"+(i||""))},t.readAsDataURL(o)};function ie(o){return o instanceof Uint8Array?o:o instanceof ArrayBuffer?new Uint8Array(o):new Uint8Array(o.buffer,o.byteOffset,o.byteLength)}let q;function Me(o,e){if(ce&&o.data instanceof Blob)return o.data.arrayBuffer().then(ie).then(e);if(le&&(o.data instanceof ArrayBuffer||de(o.data)))return e(ie(o.data));Q(o,!1,t=>{q||(q=new TextEncoder),e(q.encode(t))})}const se="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=typeof Uint8Array=="undefined"?[]:new Uint8Array(256);for(let o=0;o<se.length;o++)A[se.charCodeAt(o)]=o;const Le=o=>{let e=o.length*.75,t=o.length,i,s=0,n,r,a,c;o[o.length-1]==="="&&(e--,o[o.length-2]==="="&&e--);const d=new ArrayBuffer(e),h=new Uint8Array(d);for(i=0;i<t;i+=4)n=A[o.charCodeAt(i)],r=A[o.charCodeAt(i+1)],a=A[o.charCodeAt(i+2)],c=A[o.charCodeAt(i+3)],h[s++]=n<<2|r>>4,h[s++]=(r&15)<<4|a>>2,h[s++]=(a&3)<<6|c&63;return d},xe=typeof ArrayBuffer=="function",K=(o,e)=>{if(typeof o!="string")return{type:"message",data:he(o,e)};const t=o.charAt(0);return t==="b"?{type:"message",data:Ae(o.substring(1),e)}:_[t]?o.length>1?{type:_[t],data:o.substring(1)}:{type:_[t]}:z},Ae=(o,e)=>{if(xe){const t=Le(o);return he(t,e)}else return{base64:!0,data:o}},he=(o,e)=>{switch(e){case"blob":return o instanceof Blob?o:new Blob([o]);case"arraybuffer":default:return o instanceof ArrayBuffer?o:o.buffer}},ue="",Re=(o,e)=>{const t=o.length,i=new Array(t);let s=0;o.forEach((n,r)=>{Q(n,!1,a=>{i[r]=a,++s===t&&e(i.join(ue))})})},Be=(o,e)=>{const t=o.split(ue),i=[];for(let s=0;s<t.length;s++){const n=K(t[s],e);if(i.push(n),n.type==="error")break}return i};function _e(){return new TransformStream({transform(o,e){Me(o,t=>{const i=t.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const n=new DataView(s.buffer);n.setUint8(0,126),n.setUint16(1,i)}else{s=new Uint8Array(9);const n=new DataView(s.buffer);n.setUint8(0,127),n.setBigUint64(1,BigInt(i))}o.data&&typeof o.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(t)})}})}let $;function R(o){return o.reduce((e,t)=>e+t.length,0)}function B(o,e){if(o[0].length===e)return o.shift();const t=new Uint8Array(e);let i=0;for(let s=0;s<e;s++)t[s]=o[0][i++],i===o[0].length&&(o.shift(),i=0);return o.length&&i<o[0].length&&(o[0]=o[0].slice(i)),t}function Ve(o,e){$||($=new TextDecoder);const t=[];let i=0,s=-1,n=!1;return new TransformStream({transform(r,a){for(t.push(r);;){if(i===0){if(R(t)<1)break;const c=B(t,1);n=(c[0]&128)===128,s=c[0]&127,s<126?i=3:s===126?i=1:i=2}else if(i===1){if(R(t)<2)break;const c=B(t,2);s=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),i=3}else if(i===2){if(R(t)<8)break;const c=B(t,8),d=new DataView(c.buffer,c.byteOffset,c.length),h=d.getUint32(0);if(h>Math.pow(2,21)-1){a.enqueue(z);break}s=h*Math.pow(2,32)+d.getUint32(4),i=3}else{if(R(t)<s)break;const c=B(t,s);a.enqueue(K(n?c:$.decode(c),e)),i=0}if(s===0||s>o){a.enqueue(z);break}}}})}const me=4;function f(o){if(o)return He(o)}function He(o){for(var e in f.prototype)o[e]=f.prototype[e];return o}f.prototype.on=f.prototype.addEventListener=function(o,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+o]=this._callbacks["$"+o]||[]).push(e),this};f.prototype.once=function(o,e){function t(){this.off(o,t),e.apply(this,arguments)}return t.fn=e,this.on(o,t),this};f.prototype.off=f.prototype.removeListener=f.prototype.removeAllListeners=f.prototype.removeEventListener=function(o,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+o];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+o],this;for(var i,s=0;s<t.length;s++)if(i=t[s],i===e||i.fn===e){t.splice(s,1);break}return t.length===0&&delete this._callbacks["$"+o],this};f.prototype.emit=function(o){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+o],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(t){t=t.slice(0);for(var i=0,s=t.length;i<s;++i)t[i].apply(this,e)}return this};f.prototype.emitReserved=f.prototype.emit;f.prototype.listeners=function(o){return this._callbacks=this._callbacks||{},this._callbacks["$"+o]||[]};f.prototype.hasListeners=function(o){return!!this.listeners(o).length};const F=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),g=typeof self!="undefined"?self:typeof window!="undefined"?window:Function("return this")(),Ie="arraybuffer";function pe(o,...e){return e.reduce((t,i)=>(o.hasOwnProperty(i)&&(t[i]=o[i]),t),{})}const Fe=g.setTimeout,Oe=g.clearTimeout;function O(o,e){e.useNativeTimers?(o.setTimeoutFn=Fe.bind(g),o.clearTimeoutFn=Oe.bind(g)):(o.setTimeoutFn=g.setTimeout.bind(g),o.clearTimeoutFn=g.clearTimeout.bind(g))}const qe=1.33;function $e(o){return typeof o=="string"?Ne(o):Math.ceil((o.byteLength||o.size)*qe)}function Ne(o){let e=0,t=0;for(let i=0,s=o.length;i<s;i++)e=o.charCodeAt(i),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(i++,t+=4);return t}function fe(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function ze(o){let e="";for(let t in o)o.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(o[t]));return e}function Ue(o){let e={},t=o.split("&");for(let i=0,s=t.length;i<s;i++){let n=t[i].split("=");e[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return e}class De extends Error{constructor(e,t,i){super(e),this.description=t,this.context=i,this.type="TransportError"}}class Y extends f{constructor(e){super(),this.writable=!1,O(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,i){return super.emitReserved("error",new De(e,t,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=K(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=ze(e);return t.length?"?"+t:""}}class je extends Y{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||t()})),this.writable||(i++,this.once("drain",function(){--i||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};Be(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Re(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=fe()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let ye=!1;try{ye=typeof XMLHttpRequest!="undefined"&&"withCredentials"in new XMLHttpRequest}catch(o){}const We=ye;function Je(){}class Qe extends je{constructor(e){if(super(e),typeof location!="undefined"){const t=location.protocol==="https:";let i=location.port;i||(i=t?"443":"80"),this.xd=typeof location!="undefined"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,t){const i=this.request({method:"POST",data:e});i.on("success",t),i.on("error",(s,n)=>{this.onError("xhr post error",s,n)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,i)=>{this.onError("xhr poll error",t,i)}),this.pollXhr=e}}class w extends f{constructor(e,t,i){super(),this.createRequest=e,O(this,i),this._opts=i,this._method=i.method||"GET",this._uri=t,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const t=pe(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(t);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let s in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(s)&&i.setRequestHeader(s,this._opts.extraHeaders[s])}}catch(s){}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(s){}try{i.setRequestHeader("Accept","*/*")}catch(s){}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var s;i.readyState===3&&((s=this._opts.cookieJar)===null||s===void 0||s.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(s){this.setTimeoutFn(()=>{this._onError(s)},0);return}typeof document!="undefined"&&(this._index=w.requestsCount++,w.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr=="undefined"||this._xhr===null)){if(this._xhr.onreadystatechange=Je,e)try{this._xhr.abort()}catch(t){}typeof document!="undefined"&&delete w.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}w.requestsCount=0;w.requests={};if(typeof document!="undefined"){if(typeof attachEvent=="function")attachEvent("onunload",oe);else if(typeof addEventListener=="function"){const o="onpagehide"in g?"pagehide":"unload";addEventListener(o,oe,!1)}}function oe(){for(let o in w.requests)w.requests.hasOwnProperty(o)&&w.requests[o].abort()}const Ke=function(){const o=ge({xdomain:!1});return o&&o.responseType!==null}();class Ye extends Qe{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=Ke&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new w(ge,this.uri(),e)}}function ge(o){const e=o.xdomain;try{if(typeof XMLHttpRequest!="undefined"&&(!e||We))return new XMLHttpRequest}catch(t){}if(!e)try{return new g[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(t){}}const ve=typeof navigator!="undefined"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Xe extends Y{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,i=ve?{}:pe(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,i)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],s=t===e.length-1;Q(i,this.supportsBinary,n=>{try{this.doWrite(i,n)}catch(r){}s&&F(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws!="undefined"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=fe()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const N=g.WebSocket||g.MozWebSocket;class Ge extends Xe{createSocket(e,t,i){return ve?new N(e,t,i):t?new N(e,t):new N(e)}doWrite(e,t){this.ws.send(t)}}class Ze extends Y{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=Ve(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(t).getReader(),s=_e();s.readable.pipeTo(e.writable),this._writer=s.writable.getWriter();const n=()=>{i.read().then(({done:a,value:c})=>{a||(this.onPacket(c),n())}).catch(a=>{})};n();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],s=t===e.length-1;this._writer.write(i).then(()=>{s&&F(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const et={websocket:Ge,webtransport:Ze,polling:Ye},tt=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,it=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function U(o){if(o.length>8e3)throw"URI too long";const e=o,t=o.indexOf("["),i=o.indexOf("]");t!=-1&&i!=-1&&(o=o.substring(0,t)+o.substring(t,i).replace(/:/g,";")+o.substring(i,o.length));let s=tt.exec(o||""),n={},r=14;for(;r--;)n[it[r]]=s[r]||"";return t!=-1&&i!=-1&&(n.source=e,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=st(n,n.path),n.queryKey=ot(n,n.query),n}function st(o,e){const t=/\/{2,9}/g,i=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function ot(o,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,s,n){s&&(t[s]=n)}),t}const D=typeof addEventListener=="function"&&typeof removeEventListener=="function",V=[];D&&addEventListener("offline",()=>{V.forEach(o=>o())},!1);class C extends f{constructor(e,t){if(super(),this.binaryType=Ie,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const i=U(e);t.hostname=i.host,t.secure=i.protocol==="https"||i.protocol==="wss",t.port=i.port,i.query&&(t.query=i.query)}else t.host&&(t.hostname=U(t.host).host);O(this,t),this.secure=t.secure!=null?t.secure:typeof location!="undefined"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location!="undefined"?location.hostname:"localhost"),this.port=t.port||(typeof location!="undefined"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(i=>{const s=i.prototype.name;this.transports.push(s),this._transportsByName[s]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Ue(this.opts.query)),D&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},V.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=me,t.transport=e,this.id&&(t.sid=this.id);const i=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&C.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",C.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let i=0;i<this.writeBuffer.length;i++){const s=this.writeBuffer[i].data;if(s&&(t+=$e(s)),i>0&&t>this._maxPayload)return this.writeBuffer.slice(0,i);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,F(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,i){return this._sendPacket("message",e,t,i),this}send(e,t,i){return this._sendPacket("message",e,t,i),this}_sendPacket(e,t,i,s){if(typeof t=="function"&&(s=t,t=void 0),typeof i=="function"&&(s=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const n={type:e,data:t,options:i};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},i=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(C.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),D&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=V.indexOf(this._offlineEventListener);i!==-1&&V.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}C.protocol=me;class nt extends C{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),i=!1;C.priorWebsocketSuccess=!1;const s=()=>{i||(t.send([{type:"ping",data:"probe"}]),t.once("packet",p=>{if(!i)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;C.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(h(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const u=new Error("probe error");u.transport=t.name,this.emitReserved("upgradeError",u)}}))};function n(){i||(i=!0,h(),t.close(),t=null)}const r=p=>{const u=new Error("probe error: "+p);u.transport=t.name,n(),this.emitReserved("upgradeError",u)};function a(){r("transport closed")}function c(){r("socket closed")}function d(p){t&&p.name!==t.name&&n()}const h=()=>{t.removeListener("open",s),t.removeListener("error",r),t.removeListener("close",a),this.off("close",c),this.off("upgrading",d)};t.once("open",s),t.once("error",r),t.once("close",a),this.once("close",c),this.once("upgrading",d),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&t.push(e[i]);return t}}let rt=class extends nt{constructor(e,t={}){const i=typeof e=="object"?e:t;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(s=>et[s]).filter(s=>!!s)),super(e,i)}};function at(o,e="",t){let i=o;t=t||typeof location!="undefined"&&location,o==null&&(o=t.protocol+"//"+t.host),typeof o=="string"&&(o.charAt(0)==="/"&&(o.charAt(1)==="/"?o=t.protocol+o:o=t.host+o),/^(https?|wss?):\/\//.test(o)||(typeof t!="undefined"?o=t.protocol+"//"+o:o="https://"+o),i=U(o)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const n=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+n+":"+i.port+e,i.href=i.protocol+"://"+n+(t&&t.port===i.port?"":":"+i.port),i}const ct=typeof ArrayBuffer=="function",lt=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o.buffer instanceof ArrayBuffer,be=Object.prototype.toString,dt=typeof Blob=="function"||typeof Blob!="undefined"&&be.call(Blob)==="[object BlobConstructor]",ht=typeof File=="function"||typeof File!="undefined"&&be.call(File)==="[object FileConstructor]";function X(o){return ct&&(o instanceof ArrayBuffer||lt(o))||dt&&o instanceof Blob||ht&&o instanceof File}function H(o,e){if(!o||typeof o!="object")return!1;if(Array.isArray(o)){for(let t=0,i=o.length;t<i;t++)if(H(o[t]))return!0;return!1}if(X(o))return!0;if(o.toJSON&&typeof o.toJSON=="function"&&arguments.length===1)return H(o.toJSON(),!0);for(const t in o)if(Object.prototype.hasOwnProperty.call(o,t)&&H(o[t]))return!0;return!1}function ut(o){const e=[],t=o.data,i=o;return i.data=j(t,e),i.attachments=e.length,{packet:i,buffers:e}}function j(o,e){if(!o)return o;if(X(o)){const t={_placeholder:!0,num:e.length};return e.push(o),t}else if(Array.isArray(o)){const t=new Array(o.length);for(let i=0;i<o.length;i++)t[i]=j(o[i],e);return t}else if(typeof o=="object"&&!(o instanceof Date)){const t={};for(const i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=j(o[i],e));return t}return o}function mt(o,e){return o.data=W(o.data,e),delete o.attachments,o}function W(o,e){if(!o)return o;if(o&&o._placeholder===!0){if(typeof o.num=="number"&&o.num>=0&&o.num<e.length)return e[o.num];throw new Error("illegal attachments")}else if(Array.isArray(o))for(let t=0;t<o.length;t++)o[t]=W(o[t],e);else if(typeof o=="object")for(const t in o)Object.prototype.hasOwnProperty.call(o,t)&&(o[t]=W(o[t],e));return o}const pt=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],ft=5;var m;(function(o){o[o.CONNECT=0]="CONNECT",o[o.DISCONNECT=1]="DISCONNECT",o[o.EVENT=2]="EVENT",o[o.ACK=3]="ACK",o[o.CONNECT_ERROR=4]="CONNECT_ERROR",o[o.BINARY_EVENT=5]="BINARY_EVENT",o[o.BINARY_ACK=6]="BINARY_ACK"})(m||(m={}));class yt{constructor(e){this.replacer=e}encode(e){return(e.type===m.EVENT||e.type===m.ACK)&&H(e)?this.encodeAsBinary({type:e.type===m.EVENT?m.BINARY_EVENT:m.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===m.BINARY_EVENT||e.type===m.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=ut(e),i=this.encodeAsString(t.packet),s=t.buffers;return s.unshift(i),s}}function ne(o){return Object.prototype.toString.call(o)==="[object Object]"}class G extends f{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const i=t.type===m.BINARY_EVENT;i||t.type===m.BINARY_ACK?(t.type=i?m.EVENT:m.ACK,this.reconstructor=new gt(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(X(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const i={type:Number(e.charAt(0))};if(m[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===m.BINARY_EVENT||i.type===m.BINARY_ACK){const n=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const r=e.substring(n,t);if(r!=Number(r)||e.charAt(t)!=="-")throw new Error("Illegal attachments");i.attachments=Number(r)}if(e.charAt(t+1)==="/"){const n=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););i.nsp=e.substring(n,t)}else i.nsp="/";const s=e.charAt(t+1);if(s!==""&&Number(s)==s){const n=t+1;for(;++t;){const r=e.charAt(t);if(r==null||Number(r)!=r){--t;break}if(t===e.length)break}i.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){const n=this.tryParse(e.substr(t));if(G.isPayloadValid(i.type,n))i.data=n;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case m.CONNECT:return ne(t);case m.DISCONNECT:return t===void 0;case m.CONNECT_ERROR:return typeof t=="string"||ne(t);case m.EVENT:case m.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&pt.indexOf(t[0])===-1);case m.ACK:case m.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class gt{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=mt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const vt=Object.freeze(Object.defineProperty({__proto__:null,Decoder:G,Encoder:yt,get PacketType(){return m},protocol:ft},Symbol.toStringTag,{value:"Module"}));function b(o,e,t){return o.on(e,t),function(){o.off(e,t)}}const bt=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Se extends f{constructor(e,t,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[b(e,"open",this.onopen.bind(this)),b(e,"packet",this.onpacket.bind(this)),b(e,"error",this.onerror.bind(this)),b(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var i,s,n;if(bt.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const r={type:m.EVENT,data:t};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const h=this.ids++,p=t.pop();this._registerAckCallback(h,p),r.id=h}const a=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable,c=this.connected&&!(!((n=this.io.engine)===null||n===void 0)&&n._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,t){var i;const s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===void 0){this.acks[e]=t;return}const n=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},s),r=(...a)=>{this.io.clearTimeoutFn(n),t.apply(this,a)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...t){return new Promise((i,s)=>{const n=(r,a)=>r?s(r):i(a);n.withError=!0,t.push(n),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...n)=>i!==this._queue[0]?void 0:(s!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(s)):(this._queue.shift(),t&&t(null,...n)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:m.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case m.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case m.EVENT:case m.BINARY_EVENT:this.onevent(e);break;case m.ACK:case m.BINARY_ACK:this.onack(e);break;case m.DISCONNECT:this.ondisconnect();break;case m.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const i of t)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let i=!1;return function(...s){i||(i=!0,t.packet({type:m.ACK,id:e,data:s}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:m.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const i of t)i.apply(this,e.data)}}}function L(o){o=o||{},this.ms=o.min||100,this.max=o.max||1e4,this.factor=o.factor||2,this.jitter=o.jitter>0&&o.jitter<=1?o.jitter:0,this.attempts=0}L.prototype.duration=function(){var o=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*o);o=(Math.floor(e*10)&1)==0?o-t:o+t}return Math.min(o,this.max)|0};L.prototype.reset=function(){this.attempts=0};L.prototype.setMin=function(o){this.ms=o};L.prototype.setMax=function(o){this.max=o};L.prototype.setJitter=function(o){this.jitter=o};class J extends f{constructor(e,t){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,O(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((i=t.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new L({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||vt;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new rt(this.uri,this.opts);const t=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const s=b(t,"open",function(){i.onopen(),e&&e()}),n=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},r=b(t,"error",n);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{s(),n(new Error("timeout")),t.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(s),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(b(e,"ping",this.onping.bind(this)),b(e,"data",this.ondata.bind(this)),b(e,"error",this.onerror.bind(this)),b(e,"close",this.onclose.bind(this)),b(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){F(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new Se(this,e,t),this.nsps[e]=i),i}_destroy(e){const t=Object.keys(this.nsps);for(const i of t)if(this.nsps[i].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let i=0;i<t.length;i++)this.engine.write(t[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},t);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const x={};function I(o,e){typeof o=="object"&&(e=o,o=void 0),e=e||{};const t=at(o,e.path||"/socket.io"),i=t.source,s=t.id,n=t.path,r=x[s]&&n in x[s].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||r;let c;return a?c=new J(i,e):(x[s]||(x[s]=new J(i,e)),c=x[s]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(I,{Manager:J,Socket:Se,io:I,connect:I});class St{constructor(){this.socket=null,this.isConnected=!1,this.serverUrl="https://beemoo-server.fly.dev"}connect(){if(this.socket&&this.isConnected){console.warn("Socket already connected");return}console.log("🔌 Connecting to BeeMoo server...",this.serverUrl),this.socket=I(this.serverUrl,{cors:{origin:"http://localhost:3000",methods:["GET","POST"]}}),this.setupEventListeners()}setupEventListeners(){this.socket.on("connect",()=>{this.isConnected=!0,console.log("✅ Connected to BeeMoo server:",this.socket.id),this.updateConnectionStatus(!0)}),this.socket.on("disconnect",()=>{this.isConnected=!1,console.log("❌ Disconnected from BeeMoo server"),this.updateConnectionStatus(!1)}),this.socket.on("connect_error",e=>{console.error("🚨 Connection error:",e),this.updateConnectionStatus(!1)})}updateConnectionStatus(e){const t=document.querySelector(".connection-status");t&&(t.textContent=e?"🟢 Connected":"🔴 Disconnected",t.className=`connection-status ${e?"connected":"disconnected"}`)}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.isConnected=!1)}emit(e,t){this.socket&&this.isConnected?this.socket.emit(e,t):console.warn("Cannot emit - socket not connected")}on(e,t){this.socket&&this.socket.on(e,t)}off(e,t){this.socket&&this.socket.off(e,t)}}class wt{constructor(e,t){this.socketClient=e,this.onRoomCreated=t,this.isVisible=!1,this.isCreating=!1,this.modal=null,this.focusTimeoutId=null,this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.handleUsernameSubmit=this.handleUsernameSubmit.bind(this),this.handleCopyRoomCode=this.handleCopyRoomCode.bind(this),this.handleJoinCreatedRoom=this.handleJoinCreatedRoom.bind(this)}show(){this.isVisible||(this.isVisible=!0,this.render(),this.setupEventListeners(),typeof document!="undefined"&&(this.focusTimeoutId=setTimeout(()=>{if(!this.isVisible||typeof document=="undefined")return;const e=document.getElementById("create-username-input");e&&e.focus()},100)))}hide(){this.isVisible&&(this.isVisible=!1,this.focusTimeoutId&&(clearTimeout(this.focusTimeoutId),this.focusTimeoutId=null),this.modal&&(this.modal.remove(),this.modal=null))}render(){document.body.insertAdjacentHTML("beforeend",`
      <div class="modal-overlay" id="room-creation-modal">
        <div class="modal-content" role="dialog" aria-labelledby="create-room-title" aria-modal="true">
          <div class="modal-header">
            <h2 id="create-room-title">🏠 Create New Room</h2>
            <button class="modal-close" aria-label="Close" id="close-create-modal">&times;</button>
          </div>
          
          <div class="modal-body">
            <div id="username-step" class="step-content active">
              <div class="step-header">
                <h3>Choose Your Username</h3>
                <p>You'll be the host and control movie playback</p>
              </div>
              
              <form id="username-form" class="form-group">
                <label for="create-username-input" class="form-label">Username</label>
                <input 
                  type="text" 
                  id="create-username-input" 
                  class="form-input" 
                  placeholder="Enter your username..."
                  maxlength="30"
                  required
                  aria-describedby="username-help"
                >
                <small id="username-help" class="form-help">
                  2-30 characters, letters, numbers, and basic punctuation
                </small>
                <div id="username-error" class="form-error" aria-live="polite"></div>
                
                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" id="cancel-create">
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary" id="submit-username">
                    <span class="btn-text">Create Room</span>
                    <span class="btn-loader" style="display: none;">
                      <span class="spinner"></span> Creating...
                    </span>
                  </button>
                </div>
              </form>
            </div>
            
            <div id="room-code-step" class="step-content">
              <div class="step-header">
                <h3>🎉 Room Created Successfully!</h3>
                <p>Share this code with friends to invite them</p>
              </div>
              
              <div class="room-code-display">
                <label class="form-label">Room Code</label>
                <div class="room-code-container">
                  <span id="room-code-text" class="room-code">XXXXXX</span>
                  <button 
                    type="button" 
                    class="btn btn-icon" 
                    id="copy-room-code"
                    aria-label="Copy room code to clipboard"
                    title="Copy to clipboard"
                  >
                    📋
                  </button>
                </div>
                <small class="form-help">
                  Friends can join by entering this code
                </small>
              </div>
              
              <div class="host-info">
                <h4>As the host, you can:</h4>
                <ul>
                  <li>🎬 Control movie playback (play, pause, seek)</li>
                  <li>🎤 Manage voice chat</li>
                  <li>👥 See all participants</li>
                  <li>🗑️ End the room at any time</li>
                </ul>
              </div>
              
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="create-another">
                  Create Another Room
                </button>
                <button type="button" class="btn btn-primary" id="join-created-room">
                  Enter Room
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("room-creation-modal")}setupEventListeners(){if(!this.modal)return;const e=this.modal.querySelector("#close-create-modal"),t=this.modal.querySelector("#cancel-create"),i=this.modal;e==null||e.addEventListener("click",this.hide),t==null||t.addEventListener("click",this.hide),i==null||i.addEventListener("click",d=>{d.target===i&&this.hide()}),document.addEventListener("keydown",d=>{d.key==="Escape"&&this.isVisible&&this.hide()});const s=this.modal.querySelector("#username-form");s==null||s.addEventListener("submit",this.handleUsernameSubmit);const n=this.modal.querySelector("#copy-room-code"),r=this.modal.querySelector("#join-created-room"),a=this.modal.querySelector("#create-another");n==null||n.addEventListener("click",this.handleCopyRoomCode),r==null||r.addEventListener("click",this.handleJoinCreatedRoom),a==null||a.addEventListener("click",()=>{this.showUsernameStep()});const c=this.modal.querySelector("#create-username-input");c==null||c.addEventListener("input",this.validateUsername.bind(this))}validateUsername(e){const i=e.target.value.trim(),s=document.getElementById("username-error");if(!s)return;if(i.length===0){s.textContent="";return}if(i.length<2){s.textContent="Username must be at least 2 characters";return}if(i.length>30){s.textContent="Username must be 30 characters or less";return}if(!/^[a-zA-Z0-9\s\-_\.]+$/.test(i)){s.textContent="Username contains invalid characters";return}if([/^(system|admin|host|server|bot)$/i,/^(moderator|mod|owner)$/i].some(a=>a.test(i))){s.textContent="This username is reserved";return}s.textContent=""}handleUsernameSubmit(e){return l(this,null,function*(){if(e.preventDefault(),this.isCreating)return;const t=document.getElementById("create-username-input"),i=document.getElementById("submit-username"),s=document.getElementById("username-error");if(!t||!i||!s)return;const n=t.value.trim();if(!n){s.textContent="Username is required",t.focus();return}this.isCreating=!0,this.setButtonLoading(i,!0),s.textContent="";try{const r=yield this.createRoom(n);r.success?(this.createdRoom={roomCode:r.roomCode,username:n,room:r.room,user:r.user,participants:r.user?[r.user]:[]},this.showRoomCodeStep(r.roomCode,n)):s.textContent=r.error||"Failed to create room. Please try again."}catch(r){console.error("Room creation error:",r),s.textContent="Connection error. Please check your connection and try again."}finally{this.isCreating=!1,this.setButtonLoading(i,!1)}})}createRoom(e){return l(this,null,function*(){return new Promise(t=>{const i=n=>{this.socketClient.off("room-created",i),this.socketClient.off("create-room-error",s),t({success:!0,roomCode:n.roomCode,room:n.room,user:n.user})},s=n=>{this.socketClient.off("room-created",i),this.socketClient.off("create-room-error",s),t({success:!1,error:n.error})};this.socketClient.on("room-created",i),this.socketClient.on("create-room-error",s),this.socketClient.emit("create-room",{username:e}),setTimeout(()=>{this.socketClient.off("room-created",i),this.socketClient.off("create-room-error",s),t({success:!1,error:"Request timeout. Please try again."})},1e4)})})}showRoomCodeStep(e,t){const i=document.getElementById("username-step"),s=document.getElementById("room-code-step"),n=document.getElementById("room-code-text");if(i&&s&&n){i.classList.remove("active"),s.classList.add("active"),n.textContent=e,this.createdRoom=M(S({},this.createdRoom||{}),{roomCode:e,username:t});const r=document.getElementById("announcements");r&&(r.textContent=`Room created successfully. Room code is ${e}`)}}showUsernameStep(){const e=document.getElementById("username-step"),t=document.getElementById("room-code-step"),i=document.getElementById("create-username-input"),s=document.getElementById("username-error");e&&t&&(t.classList.remove("active"),e.classList.add("active"),i&&(i.value="",i.focus()),s&&(s.textContent=""))}handleCopyRoomCode(){return l(this,null,function*(){const e=document.getElementById("room-code-text"),t=document.getElementById("copy-room-code");if(!e||!t)return;const i=e.textContent;try{yield navigator.clipboard.writeText(i),t.textContent="✅",t.setAttribute("title","Copied!");const s=document.getElementById("announcements");s&&(s.textContent="Room code copied to clipboard"),setTimeout(()=>{t.textContent="📋",t.setAttribute("title","Copy to clipboard")},2e3)}catch(s){console.error("Failed to copy room code:",s),alert(`Room Code: ${i}

Please copy this code manually.`)}})}handleJoinCreatedRoom(){this.createdRoom&&(this.hide(),this.onRoomCreated&&this.onRoomCreated(this.createdRoom))}setButtonLoading(e,t){if(!e)return;const i=e.querySelector(".btn-text"),s=e.querySelector(".btn-loader");t?(e.disabled=!0,i&&(i.style.display="none"),s&&(s.style.display="inline-flex")):(e.disabled=!1,i&&(i.style.display="inline"),s&&(s.style.display="none"))}destroy(){this.hide(),document.removeEventListener("keydown",this.handleEscKey),this.focusTimeoutId&&(clearTimeout(this.focusTimeoutId),this.focusTimeoutId=null)}}class kt{constructor(e,t){this.socketClient=e,this.onRoomJoined=t,this.isVisible=!1,this.isJoining=!1,this.isValidatingCode=!1,this.modal=null,this.currentRoomCode=null,this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.handleRoomCodeSubmit=this.handleRoomCodeSubmit.bind(this),this.handleUsernameSubmit=this.handleUsernameSubmit.bind(this),this.handleJoinRoom=this.handleJoinRoom.bind(this)}show(){this.isVisible||(this.isVisible=!0,this.render(),this.setupEventListeners(),setTimeout(()=>{const e=document.getElementById("join-room-code-input");e&&e.focus()},100))}hide(){this.isVisible&&(this.isVisible=!1,this.modal&&(this.modal.remove(),this.modal=null),this.currentRoomCode=null,this.isJoining=!1,this.isValidatingCode=!1)}render(){document.body.insertAdjacentHTML("beforeend",`
      <div class="modal-overlay" id="room-joining-modal">
        <div class="modal-content" role="dialog" aria-labelledby="join-room-title" aria-modal="true">
          <div class="modal-header">
            <h2 id="join-room-title">🚪 Join Room</h2>
            <button class="modal-close" aria-label="Close" id="close-join-modal">&times;</button>
          </div>
          
          <div class="modal-body">
            <div id="room-code-step" class="step-content active">
              <div class="step-header">
                <h3>Enter Room Code</h3>
                <p>Enter the 6-character code shared by the host</p>
              </div>
              
              <form id="room-code-form" class="form-group">
                <label for="join-room-code-input" class="form-label">Room Code</label>
                <input 
                  type="text" 
                  id="join-room-code-input" 
                  class="form-input room-code-input" 
                  placeholder="Enter room code..."
                  maxlength="6"
                  required
                  aria-describedby="room-code-help"
                  autocomplete="off"
                  spellcheck="false"
                >
                <small id="room-code-help" class="form-help">
                  6-character code (letters and numbers)
                </small>
                <div id="room-code-error" class="form-error" aria-live="polite"></div>
                
                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" id="cancel-join">
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary" id="validate-room-code">
                    <span class="btn-text">Continue</span>
                    <span class="btn-loader" style="display: none;">
                      <span class="spinner"></span> Checking...
                    </span>
                  </button>
                </div>
              </form>
            </div>
            
            <div id="username-step" class="step-content">
              <div class="step-header">
                <h3>Choose Your Username</h3>
                <p>Join room <span id="display-room-code" class="room-code-inline">######</span></p>
              </div>
              
              <form id="join-username-form" class="form-group">
                <label for="join-username-input" class="form-label">Username</label>
                <input 
                  type="text" 
                  id="join-username-input" 
                  class="form-input" 
                  placeholder="Enter your username..."
                  maxlength="30"
                  required
                  aria-describedby="join-username-help"
                >
                <small id="join-username-help" class="form-help">
                  2-30 characters, letters, numbers, and basic punctuation
                </small>
                <div id="join-username-error" class="form-error" aria-live="polite"></div>
                
                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" id="back-to-code">
                    ← Back
                  </button>
                  <button type="submit" class="btn btn-primary" id="submit-join">
                    <span class="btn-text">Join Room</span>
                    <span class="btn-loader" style="display: none;">
                      <span class="spinner"></span> Joining...
                    </span>
                  </button>
                </div>
              </form>
            </div>
            
            <div id="success-step" class="step-content">
              <div class="step-header">
                <h3>🎉 Successfully Joined!</h3>
                <p>Welcome to room <span id="success-room-code" class="room-code-inline">######</span></p>
              </div>
              
              <div class="join-success-info">
                <h4>You're now connected:</h4>
                <ul>
                  <li>🎬 Watch movies synced with the host</li>
                  <li>🎤 Join voice chat with other participants</li>
                  <li>💬 Send messages in the room chat</li>
                  <li>🔊 Control your personal audio settings</li>
                </ul>
              </div>
              
              <div class="form-actions">
                <button type="button" class="btn btn-primary" id="enter-joined-room">
                  Enter Room
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("room-joining-modal")}setupEventListeners(){if(!this.modal)return;const e=this.modal.querySelector("#close-join-modal"),t=this.modal.querySelector("#cancel-join"),i=this.modal;e==null||e.addEventListener("click",this.hide),t==null||t.addEventListener("click",this.hide),i==null||i.addEventListener("click",h=>{h.target===i&&this.hide()}),document.addEventListener("keydown",h=>{h.key==="Escape"&&this.isVisible&&this.hide()});const s=this.modal.querySelector("#room-code-form"),n=this.modal.querySelector("#join-username-form");s==null||s.addEventListener("submit",this.handleRoomCodeSubmit),n==null||n.addEventListener("submit",this.handleUsernameSubmit);const r=this.modal.querySelector("#back-to-code"),a=this.modal.querySelector("#enter-joined-room");r==null||r.addEventListener("click",()=>this.showRoomCodeStep()),a==null||a.addEventListener("click",this.handleJoinRoom);const c=this.modal.querySelector("#join-room-code-input"),d=this.modal.querySelector("#join-username-input");c==null||c.addEventListener("input",this.formatRoomCode.bind(this)),c==null||c.addEventListener("input",this.validateRoomCodeInput.bind(this)),d==null||d.addEventListener("input",this.validateUsername.bind(this))}formatRoomCode(e){const t=e.target;let i=t.value.toUpperCase().replace(/[^A-Z0-9]/g,"");i.length>6&&(i=i.substring(0,6)),t.value=i}validateRoomCodeInput(e){const i=e.target.value.trim(),s=document.getElementById("room-code-error");if(s){if(i.length===0){s.textContent="";return}if(i.length<6){s.textContent="Room code must be 6 characters";return}if(!/^[A-Z0-9]{6}$/.test(i)){s.textContent="Room code can only contain letters and numbers";return}s.textContent=""}}validateUsername(e){const i=e.target.value.trim(),s=document.getElementById("join-username-error");if(!s)return;if(i.length===0){s.textContent="";return}if(i.length<2){s.textContent="Username must be at least 2 characters";return}if(i.length>30){s.textContent="Username must be 30 characters or less";return}if(!/^[a-zA-Z0-9\s\-_\.]+$/.test(i)){s.textContent="Username contains invalid characters";return}if([/^(system|admin|host|server|bot)$/i,/^(moderator|mod|owner)$/i].some(a=>a.test(i))){s.textContent="This username is reserved";return}s.textContent=""}handleRoomCodeSubmit(e){return l(this,null,function*(){if(e.preventDefault(),this.isValidatingCode)return;const t=document.getElementById("join-room-code-input"),i=document.getElementById("validate-room-code"),s=document.getElementById("room-code-error");if(!t||!i||!s)return;const n=t.value.trim().toUpperCase();if(!n){s.textContent="Room code is required",t.focus();return}if(n.length!==6){s.textContent="Room code must be 6 characters",t.focus();return}this.isValidatingCode=!0,this.setButtonLoading(i,!0),s.textContent="";try{const r=yield this.validateRoomCode(n);r.success?(this.currentRoomCode=n,this.showUsernameStep(n)):s.textContent=r.error||"Room not found. Please check the code and try again."}catch(r){console.error("Room validation error:",r),s.textContent="Connection error. Please check your connection and try again."}finally{this.isValidatingCode=!1,this.setButtonLoading(i,!1)}})}validateRoomCode(e){return l(this,null,function*(){return new Promise(t=>{const i=n=>{this.socketClient.off("room-exists",i),this.socketClient.off("room-not-found",s),t({success:!0,room:n.room})},s=n=>{this.socketClient.off("room-exists",i),this.socketClient.off("room-not-found",s),t({success:!1,error:n.error})};this.socketClient.on("room-exists",i),this.socketClient.on("room-not-found",s),this.socketClient.emit("validate-room",{roomCode:e}),setTimeout(()=>{this.socketClient.off("room-exists",i),this.socketClient.off("room-not-found",s),t({success:!1,error:"Request timeout. Please try again."})},1e4)})})}handleUsernameSubmit(e){return l(this,null,function*(){if(e.preventDefault(),this.isJoining)return;const t=document.getElementById("join-username-input"),i=document.getElementById("submit-join"),s=document.getElementById("join-username-error");if(!t||!i||!s||!this.currentRoomCode)return;const n=t.value.trim();if(!n){s.textContent="Username is required",t.focus();return}this.isJoining=!0,this.setButtonLoading(i,!0),s.textContent="";try{const r=yield this.joinRoom(this.currentRoomCode,n);r.success?this.showSuccessStep(this.currentRoomCode,n,r.room,r.participants):s.textContent=r.error||"Failed to join room. Please try again."}catch(r){console.error("Room joining error:",r),s.textContent="Connection error. Please check your connection and try again."}finally{this.isJoining=!1,this.setButtonLoading(i,!1)}})}joinRoom(e,t){return l(this,null,function*(){return new Promise(i=>{const s=r=>{this.socketClient.off("room-joined",s),this.socketClient.off("join-room-error",n),i({success:!0,room:r.room,user:r.user,participants:r.participants})},n=r=>{this.socketClient.off("room-joined",s),this.socketClient.off("join-room-error",n),i({success:!1,error:r.error})};this.socketClient.on("room-joined",s),this.socketClient.on("join-room-error",n),this.socketClient.emit("join-room",{roomCode:e,username:t}),setTimeout(()=>{this.socketClient.off("room-joined",s),this.socketClient.off("join-room-error",n),i({success:!1,error:"Request timeout. Please try again."})},1e4)})})}showRoomCodeStep(){const e=document.getElementById("room-code-step"),t=document.getElementById("username-step"),i=document.getElementById("join-room-code-input"),s=document.getElementById("room-code-error");e&&t&&(t.classList.remove("active"),e.classList.add("active"),i&&i.focus(),s&&(s.textContent=""))}showUsernameStep(e){const t=document.getElementById("room-code-step"),i=document.getElementById("username-step"),s=document.getElementById("join-username-input"),n=document.getElementById("display-room-code"),r=document.getElementById("join-username-error");if(t&&i){t.classList.remove("active"),i.classList.add("active"),n&&(n.textContent=e),s&&(s.value="",s.focus()),r&&(r.textContent="");const a=document.getElementById("announcements");a&&(a.textContent=`Room ${e} found. Please enter your username.`)}}showSuccessStep(e,t,i,s){const n=document.getElementById("username-step"),r=document.getElementById("success-step"),a=document.getElementById("success-room-code");if(n&&r){n.classList.remove("active"),r.classList.add("active"),a&&(a.textContent=e),this.joinedRoom={roomCode:e,username:t,room:i,participants:s};const c=document.getElementById("announcements");c&&(c.textContent=`Successfully joined room ${e}`)}}handleJoinRoom(){this.joinedRoom&&(this.hide(),this.onRoomJoined&&this.onRoomJoined(this.joinedRoom))}setButtonLoading(e,t){if(!e)return;const i=e.querySelector(".btn-text"),s=e.querySelector(".btn-loader");t?(e.disabled=!0,i&&(i.style.display="none"),s&&(s.style.display="inline-flex")):(e.disabled=!1,i&&(i.style.display="inline"),s&&(s.style.display="none"))}destroy(){this.hide(),document.removeEventListener("keydown",this.handleEscKey)}}const Et="modulepreload",Ct=function(o){return"/"+o},re={},Tt=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let r=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=r(t.map(d=>{if(d=Ct(d),d in re)return;re[d]=!0;const h=d.endsWith(".css"),p=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${p}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":Et,h||(u.as="script"),u.crossOrigin="",u.href=d,c&&u.setAttribute("nonce",c),document.head.appendChild(u),h)return new Promise((y,v)=>{u.addEventListener("load",y),u.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${d}`)))})}))}function n(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&n(a.reason);return e().catch(n)})};class Pt{constructor(e){this.socketClient=e,this.container=null,this.participantsBySocketId=new Map,this.socketIdToVolume=new Map,this.boundHandlers=!1,this.onVolumeChange=null,this.attach=this.attach.bind(this),this.detach=this.detach.bind(this),this.destroy=this.destroy.bind(this),this.setParticipants=this.setParticipants.bind(this),this.addOrUpdateParticipant=this.addOrUpdateParticipant.bind(this),this.removeParticipant=this.removeParticipant.bind(this),this.render=this.render.bind(this),this.renderItem=this.renderItem.bind(this),this.bindSocketEvents=this.bindSocketEvents.bind(this),this.unbindSocketEvents=this.unbindSocketEvents.bind(this),this.onParticipantJoined=this.onParticipantJoined.bind(this),this.onParticipantLeft=this.onParticipantLeft.bind(this),this.onParticipantMicUpdated=this.onParticipantMicUpdated.bind(this),this.onParticipantDisconnected=this.onParticipantDisconnected.bind(this),this._onVolumeInput=this._onVolumeInput.bind(this)}attach(e){e&&(this.container=e,this.container.classList.add("participants-panel"),this.render(),this.bindSocketEvents(),this.container.addEventListener("input",this._onVolumeInput))}detach(){this.container&&(this.container.removeEventListener("input",this._onVolumeInput),this.container.innerHTML="",this.container.classList.remove("participants-panel")),this.container=null,this.unbindSocketEvents()}destroy(){this.detach(),this.participantsBySocketId.clear()}bindSocketEvents(){this.boundHandlers||(this.socketClient.on("participant-joined",this.onParticipantJoined),this.socketClient.on("participant-left",this.onParticipantLeft),this.socketClient.on("participant-mic-updated",this.onParticipantMicUpdated),this.socketClient.on("mic-updated",this.onParticipantMicUpdated),this.socketClient.on("participant-disconnected",this.onParticipantDisconnected),this.boundHandlers=!0)}unbindSocketEvents(){this.boundHandlers&&(this.socketClient.off("participant-joined",this.onParticipantJoined),this.socketClient.off("participant-left",this.onParticipantLeft),this.socketClient.off("participant-mic-updated",this.onParticipantMicUpdated),this.socketClient.off("mic-updated",this.onParticipantMicUpdated),this.socketClient.off("participant-disconnected",this.onParticipantDisconnected),this.boundHandlers=!1)}setParticipants(e){if(this.participantsBySocketId.clear(),Array.isArray(e))for(const t of e)t&&t.socketId&&this.participantsBySocketId.set(t.socketId,{socketId:t.socketId,username:t.username||"Unknown",isHost:!!t.isHost,muted:typeof t.micMuted=="boolean"?t.micMuted:!!t.muted});this.render()}addOrUpdateParticipant(e){var i,s,n,r,a,c;if(!e||!e.socketId)return;const t=this.participantsBySocketId.get(e.socketId)||{};this.participantsBySocketId.set(e.socketId,{socketId:e.socketId,username:(s=(i=e.username)!=null?i:t.username)!=null?s:"Unknown",isHost:(r=(n=e.isHost)!=null?n:t.isHost)!=null?r:!1,muted:(c=(a=typeof e.micMuted=="boolean"?e.micMuted:e.muted)!=null?a:t.muted)!=null?c:!1}),this.render()}removeParticipant(e){!e||!e.socketId||(this.participantsBySocketId.delete(e.socketId),this.render())}onParticipantJoined(e){if(e!=null&&e.participants){this.setParticipants(e.participants);return}e!=null&&e.participant&&this.addOrUpdateParticipant(e.participant)}onParticipantLeft(e){if(e!=null&&e.participants){this.setParticipants(e.participants);return}e!=null&&e.participant&&this.removeParticipant(e.participant)}onParticipantMicUpdated(e){if(e!=null&&e.participants){this.setParticipants(e.participants);return}e!=null&&e.participant&&this.addOrUpdateParticipant(e.participant)}onParticipantDisconnected(e){if(e!=null&&e.participants){this.setParticipants(e.participants);return}e!=null&&e.participant&&this.removeParticipant(e.participant)}render(){if(!this.container)return;const e=Array.from(this.participantsBySocketId.values()),t=`
      <div class="participants-header">
        <h3 class="participants-title">Participants</h3>
        <span class="participants-count" aria-live="polite">${e.length}</span>
      </div>
    `,s=`
      <ul class="participants-list" role="list">
        ${e.map(this.renderItem).join("")||'<li class="participant empty">Waiting for participants…</li>'}
      </ul>
    `;this.container.innerHTML=t+s}renderItem(e){var c;const t=e.muted?"🔇":"🎤",i=e.muted?"muted":"live",s=e.isHost?'<span class="badge badge-host" title="Host">HOST</span>':"",n=Math.round((c=this.socketIdToVolume.get(e.socketId))!=null?c:100),r=this.escapeHtml(e.username),a=String(e.username).replace(/[<>]/g,"");return`
      <li class="participant" data-socket-id="${e.socketId}">
        <div class="participant-left">
          <span class="participant-avatar" aria-hidden="true">${e.username.charAt(0).toUpperCase()}</span>
          <div class="participant-info">
            <span class="participant-name">${r} ${s}</span>
          </div>
        </div>
        <div class="participant-right">
          <input type="range" class="participant-volume" data-socket-id="${e.socketId}" min="0" max="100" value="${n}" aria-label="Volume for ${a}" />
          <span class="participant-mic ${i}" aria-label="${e.muted?"Muted":"Unmuted"}">${t}</span>
        </div>
      </li>
    `}escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}_onVolumeInput(e){const t=e.target;if(!t.classList.contains("participant-volume"))return;const i=t.getAttribute("data-socket-id"),s=Math.max(0,Math.min(100,parseInt(t.value||"0",10)));this.socketIdToVolume.set(i,s),typeof this.onVolumeChange=="function"&&this.onVolumeChange(i,s/100)}}class E{static getAudioConstraints(e={}){const{echoCancellation:t=!0,noiseSuppression:i=!0,autoGainControl:s=!0,deviceId:n=void 0}=e,r={audio:{echoCancellation:t,noiseSuppression:i,autoGainControl:s},video:!1};return n&&(r.audio.deviceId={exact:n}),r}static getVideoStreamConstraints(e={}){const{width:t=1280,height:i=720,frameRate:s=30,bitrate:n=25e5,quality:r="high"}=e,a={low:{width:640,height:360,frameRate:24,bitrate:8e5},medium:{width:854,height:480,frameRate:30,bitrate:15e5},high:{width:1280,height:720,frameRate:30,bitrate:25e5},ultra:{width:1920,height:1080,frameRate:30,bitrate:4e6}},c=a[r]||a.high;return{video:{width:{ideal:c.width},height:{ideal:c.height},frameRate:{ideal:c.frameRate}},audio:!1}}static createVideoStreamFromElement(e,t={}){try{if(!e||typeof e.captureStream!="function")throw new Error("Video element does not support captureStream");const{frameRate:i=30,quality:s="high",includeAudio:n=!0}=t;console.log("🎥 Capturing stream from video element:",{currentSrc:e.currentSrc,videoWidth:e.videoWidth,videoHeight:e.videoHeight,muted:e.muted,volume:e.volume,readyState:e.readyState});const r=e.muted;n&&(e.muted=!1);const a=e.captureStream(i);if(e.muted=r,!a)throw new Error("Failed to capture stream from video element");const c=a.getVideoTracks(),d=a.getAudioTracks();if(console.log(`🎥 Created stream with ${c.length} video tracks and ${d.length} audio tracks`),c.length===0)throw new Error("No video tracks in captured stream");return c.forEach((h,p)=>{var u;console.log(`🎥 Video track ${p}:`,{id:h.id,label:h.label,enabled:h.enabled,readyState:h.readyState,settings:(u=h.getSettings)==null?void 0:u.call(h)})}),d.forEach((h,p)=>{var u;console.log(`🔊 Audio track ${p}:`,{id:h.id,label:h.label,enabled:h.enabled,readyState:h.readyState,settings:(u=h.getSettings)==null?void 0:u.call(h)})}),{success:!0,stream:a,error:null}}catch(i){return console.error("❌ Failed to create video stream:",i),{success:!1,stream:null,error:i}}}static checkWebRTCSupport(){const e={webrtc:!!window.RTCPeerConnection,mediaDevices:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),captureStream:!!(HTMLVideoElement.prototype.captureStream||HTMLVideoElement.prototype.mozCaptureStream),mediaRecorder:!!window.MediaRecorder,supported:!1};return e.supported=e.webrtc&&e.mediaDevices&&e.captureStream,e}static getVideoEncodingParams(e="high",t="fast"){const i={low:{maxBitrate:5e5,scaleResolutionDownBy:4},medium:{maxBitrate:1e6,scaleResolutionDownBy:2},high:{maxBitrate:25e5,scaleResolutionDownBy:1},ultra:{maxBitrate:4e6,scaleResolutionDownBy:1}},s={slow:.5,medium:.75,fast:1,excellent:1.25},n=i[e]||i.high,r=s[t]||1;return{maxBitrate:Math.round(n.maxBitrate*r),scaleResolutionDownBy:n.scaleResolutionDownBy,degradationPreference:t==="slow"?"maintain-framerate":"maintain-resolution"}}static requestMicrophonePermissions(){return l(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!1})).getTracks().forEach(t=>t.stop()),{granted:!0}}catch(e){return{granted:!1,error:e}}})}static listAudioInputDevices(){return l(this,null,function*(){try{return{success:!0,devices:(yield navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="audioinput").map(i=>({deviceId:i.deviceId,label:i.label||"Microphone",groupId:i.groupId||void 0}))}}catch(e){return{success:!1,error:e}}})}}class Mt{constructor(e){this.socket=e,this.handlers={offer:null,answer:null,ice:null}}onOffer(e){this.handlers.offer=e,this.socket.on("webrtc-offer",e)}onAnswer(e){this.handlers.answer=e,this.socket.on("webrtc-answer",e)}onIceCandidate(e){this.handlers.ice=e,this.socket.on("webrtc-ice-candidate",e)}offAll(){this.handlers.offer&&this.socket.off("webrtc-offer",this.handlers.offer),this.handlers.answer&&this.socket.off("webrtc-answer",this.handlers.answer),this.handlers.ice&&this.socket.off("webrtc-ice-candidate",this.handlers.ice),this.handlers={offer:null,answer:null,ice:null}}sendOffer(e,t){this.socket.emit("webrtc-offer",{sdp:e,to:t})}sendAnswer(e,t){this.socket.emit("webrtc-answer",{sdp:e,to:t})}sendIceCandidate(e,t){this.socket.emit("webrtc-ice-candidate",{candidate:e,to:t})}}class ae{constructor(e,t){this.socketClient=e,this.signaling=new Mt(e),this.peerIdToPc=new Map,this.localStreamProvider=t,this.onRemoteTrack=null,this.onRemoteVideoTrack=null,this.currentLocalStream=null,this.currentVideoStream=null,this.isHost=!1,this.videoQuality="high",this.connectionQuality=new Map,this.signaling.onOffer(n=>l(this,[n],function*({from:i,sdp:s}){yield this.handleOffer(i,s)})),this.signaling.onAnswer(n=>l(this,[n],function*({from:i,sdp:s}){yield this.handleAnswer(i,s)})),this.signaling.onIceCandidate(n=>l(this,[n],function*({from:i,candidate:s}){const r=this.peerIdToPc.get(i);if(r&&s)try{yield r.addIceCandidate(s)}catch(a){}}))}ensurePeer(e){return l(this,null,function*(){if(this.peerIdToPc.has(e))return this.peerIdToPc.get(e);const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});t.onicecandidate=s=>{s.candidate&&this.signaling.sendIceCandidate(s.candidate,e)},t.ontrack=s=>{if(s.streams&&s.streams[0]){const n=s.streams[0],r=s.track;console.log(`📡 Received ${r.kind} track from peer ${e}:`,{trackId:r.id,trackLabel:r.label,streamId:n.id,streamTracks:{video:n.getVideoTracks().length,audio:n.getAudioTracks().length}}),r.kind==="audio"&&r.label!=="video-audio"&&this.onRemoteTrack&&(console.log(`🎙️ Voice chat audio track from peer ${e}`),this.onRemoteTrack(e,n)),r.kind==="video"&&this.onRemoteVideoTrack&&(console.log(`🎥 Video track from peer ${e} - calling onRemoteVideoTrack`),this.onRemoteVideoTrack(e,n)),r.kind==="audio"&&(r.label==="video-audio"||n.getVideoTracks().length>0)&&console.log(`🔊 Video audio track from peer ${e} - will be handled with video stream`)}},t.oniceconnectionstatechange=()=>{this.updateConnectionQuality(e,t)};const i=yield this._getOrCreateLocalStream();return i.getTracks().forEach(s=>t.addTrack(s,i)),this.isHost&&this.currentVideoStream&&this.currentVideoStream.getVideoTracks().forEach(s=>{const n=t.addTrack(s,this.currentVideoStream);this.configureVideoSender(n,e)}),this.peerIdToPc.set(e,t),t})}callPeer(e){return l(this,null,function*(){const t=yield this.ensurePeer(e),i=yield t.createOffer();yield t.setLocalDescription(i),this.signaling.sendOffer(i,e)})}handleOffer(e,t){return l(this,null,function*(){const i=yield this.ensurePeer(e);yield i.setRemoteDescription(new RTCSessionDescription(t));const s=yield i.createAnswer();yield i.setLocalDescription(s),this.signaling.sendAnswer(s,e)})}handleAnswer(e,t){return l(this,null,function*(){const i=this.peerIdToPc.get(e);i&&(yield i.setRemoteDescription(new RTCSessionDescription(t)))})}closePeer(e){const t=this.peerIdToPc.get(e);t&&(t.getSenders().forEach(i=>{try{t.removeTrack(i)}catch(s){}}),t.close(),this.peerIdToPc.delete(e))}replaceLocalStream(e){return l(this,null,function*(){this.currentLocalStream=e;for(const t of this.peerIdToPc.values()){const i=t.getSenders().filter(n=>n.track&&n.track.kind==="audio"),s=e.getAudioTracks()[0];for(const n of i)try{yield n.replaceTrack(s)}catch(r){}}})}startVideoStreaming(i){return l(this,arguments,function*(e,t={}){if(!this.isHost)throw new Error("Only host can start video streaming");try{if(!E.checkWebRTCSupport().supported)throw new Error("Browser does not support required WebRTC features");const n=E.createVideoStreamFromElement(e,t);if(!n.success)throw new Error(`Failed to create video stream: ${n.error.message}`);this.currentVideoStream=n.stream,console.log("🎥 Video streaming started successfully");for(const[r,a]of this.peerIdToPc.entries()){for(const c of this.currentVideoStream.getVideoTracks()){const d=a.addTrack(c,this.currentVideoStream);this.configureVideoSender(d,r),console.log(`🎥 Added video track to peer ${r}`)}for(const c of this.currentVideoStream.getAudioTracks()){const d=a.addTrack(c,this.currentVideoStream);console.log(`🔊 Added video audio track to peer ${r}:`,{id:c.id,label:c.label,enabled:c.enabled})}yield this.renegotiatePeer(r)}return{success:!0,stream:this.currentVideoStream}}catch(s){return console.error("❌ Failed to start video streaming:",s),{success:!1,error:s.message}}})}stopVideoStreaming(){return l(this,null,function*(){if(this.currentVideoStream)try{for(const e of this.peerIdToPc.values()){const t=e.getSenders().filter(i=>i.track&&i.track.kind==="video");for(const i of t)e.removeTrack(i)}this.currentVideoStream.getVideoTracks().forEach(e=>e.stop()),this.currentVideoStream=null;for(const e of this.peerIdToPc.keys())yield this.renegotiatePeer(e);return console.log("🎥 Video streaming stopped"),{success:!0}}catch(e){return console.error("❌ Failed to stop video streaming:",e),{success:!1,error:e.message}}})}configureVideoSender(e,t){return l(this,null,function*(){if(!(!e||!e.track||e.track.kind!=="video"))try{const i=e.getParameters();(!i.encodings||i.encodings.length===0)&&(i.encodings=[{}]);const s=this.getConnectionQuality(t),n=E.getVideoEncodingParams(this.videoQuality,s);i.encodings[0].maxBitrate=n.maxBitrate,i.encodings[0].scaleResolutionDownBy=n.scaleResolutionDownBy,n.degradationPreference&&(i.degradationPreference=n.degradationPreference),yield e.setParameters(i),console.log(`🎥 Configured video sender for peer ${t}:`,n)}catch(i){console.warn(`⚠️ Failed to configure video sender for peer ${t}:`,i)}})}updateConnectionQuality(e,t){t&&t.getStats().then(i=>{let s="fast",n=0,r=0;i.forEach(a=>{a.type==="candidate-pair"&&a.state==="succeeded"&&(n=a.currentRoundTripTime*1e3),a.type==="inbound-rtp"&&a.kind==="video"&&(r=a.packetsLost||0)}),n>500||r>5?s="slow":n>200||r>2?s="medium":n<100&&(s="excellent"),this.connectionQuality.set(e,s),this.adaptVideoQuality(e,s)}).catch(i=>{console.warn(`⚠️ Failed to get stats for peer ${e}:`,i)})}adaptVideoQuality(e,t){return l(this,null,function*(){const i=this.peerIdToPc.get(e);if(!i||!this.isHost)return;const s=i.getSenders().filter(n=>n.track&&n.track.kind==="video");for(const n of s)yield this.configureVideoSender(n,e)})}getConnectionQuality(e){return this.connectionQuality.get(e)||"fast"}renegotiatePeer(e){return l(this,null,function*(){const t=this.peerIdToPc.get(e);if(t)try{const i=yield t.createOffer();yield t.setLocalDescription(i),this.signaling.sendOffer(i,e)}catch(i){console.error(`❌ Failed to renegotiate peer ${e}:`,i)}})}setVideoQuality(e){if(this.videoQuality=e,console.log(`🎥 Video quality set to: ${e}`),this.isHost)for(const t of this.peerIdToPc.keys())this.adaptVideoQuality(t,this.getConnectionQuality(t))}setHost(e){this.isHost=e,console.log(`🎥 Peer role set to: ${e?"HOST":"PARTICIPANT"}`)}_getOrCreateLocalStream(){return l(this,null,function*(){return this.currentLocalStream?this.currentLocalStream:(this.currentLocalStream=yield this.localStreamProvider(),this.currentLocalStream)})}destroy(){this.currentVideoStream&&(this.currentVideoStream.getVideoTracks().forEach(e=>e.stop()),this.currentVideoStream=null);for(const e of Array.from(this.peerIdToPc.keys()))this.closePeer(e);this.signaling.offAll(),this.connectionQuality.clear(),console.log("🎥 PeerManager destroyed")}}class Lt{constructor(e,t){this.socketClient=e,this.onFileSelected=t,this.selectedFile=null,this.isUploading=!1,this.supportedFormats={"video/mp4":{ext:"mp4",name:"MP4 (H.264)"},"video/webm":{ext:"webm",name:"WebM"},"video/ogg":{ext:"ogv",name:"Ogg Video"},"video/quicktime":{ext:"mov",name:"QuickTime (limited support)"}},this.maxFileSize=1024*1024*1024}render(){return`
      <div class="movie-file-selector" id="movie-file-selector">
        <div class="file-selector-header">
          <h3>Select Movie File</h3>
          <p class="file-selector-desc">Choose a video file to stream to your party</p>
        </div>
        
        <div class="file-input-container">
          <label for="movie-file-input" class="file-input-label">
            <div class="file-input-drop-zone" id="drop-zone">
              <div class="file-input-content">
                <svg class="file-upload-icon" viewBox="0 0 24 24" width="48" height="48">
                  <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
                <div class="file-input-text">
                  <span class="file-input-primary">Drop video file here or click to browse</span>
                  <span class="file-input-secondary">Supports MP4, WebM, OGG • Max 1GB</span>
                </div>
              </div>
            </div>
            <input 
              type="file" 
              id="movie-file-input" 
              accept="video/mp4,video/webm,video/ogg,video/quicktime" 
              class="file-input-hidden"
            />
          </label>
        </div>

        <div class="file-validation-info" id="validation-info" style="display: none;">
          <div class="file-info">
            <div class="file-details">
              <span class="file-name" id="file-name"></span>
              <span class="file-meta" id="file-meta"></span>
            </div>
            <div class="file-status" id="file-status"></div>
          </div>
          <div class="file-actions">
            <button type="button" class="btn btn-secondary btn-small" id="clear-file">
              Remove File
            </button>
            <button type="button" class="btn btn-primary" id="start-streaming" disabled>
              Start Streaming
            </button>
          </div>
        </div>

        <div class="upload-progress" id="upload-progress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
          </div>
          <div class="progress-text">
            <span id="progress-percent">0%</span>
            <span id="progress-status">Preparing file...</span>
          </div>
        </div>

        <div class="format-support-info">
          <details class="support-details">
            <summary>Supported Video Formats</summary>
            <div class="format-list">
              <div class="format-item recommended">
                <strong>MP4 (H.264)</strong> - Best compatibility, recommended
              </div>
              <div class="format-item">
                <strong>WebM</strong> - Good compression, modern browsers
              </div>
              <div class="format-item">
                <strong>OGG Video</strong> - Open source format
              </div>
              <div class="format-item limited">
                <strong>QuickTime (MOV)</strong> - Limited browser support
              </div>
            </div>
          </details>
        </div>
      </div>
    `}mount(e){e&&(e.innerHTML=this.render(),this.setupEventListeners())}setupEventListeners(){const e=document.getElementById("movie-file-input"),t=document.getElementById("drop-zone"),i=document.getElementById("clear-file"),s=document.getElementById("start-streaming");e==null||e.addEventListener("change",n=>{this.handleFileSelection(n.target.files[0])}),t==null||t.addEventListener("dragover",n=>{n.preventDefault(),t.classList.add("drag-over")}),t==null||t.addEventListener("dragleave",n=>{n.preventDefault(),t.classList.remove("drag-over")}),t==null||t.addEventListener("drop",n=>{n.preventDefault(),t.classList.remove("drag-over");const r=n.dataTransfer.files;r.length>0&&this.handleFileSelection(r[0])}),i==null||i.addEventListener("click",()=>{this.clearFile()}),s==null||s.addEventListener("click",()=>{this.startStreaming()})}handleFileSelection(e){return l(this,null,function*(){if(!e)return;this.hideUploadProgress();const t=yield this.validateFileAdvanced(e);if(!t.valid){this.showValidationError(t.error);return}this.selectedFile=e,this.showFileInfo(e),this.showValidationInfo();const i=document.getElementById("start-streaming");i&&(i.disabled=!1),console.log("✅ File selected:",e.name,this.formatFileSize(e.size))})}validateFile(e){return e?this.supportedFormats[e.type]?e.size>this.maxFileSize?{valid:!1,error:`File too large. Maximum size is ${this.formatFileSize(this.maxFileSize)}`}:{valid:!0}:{valid:!1,error:`Unsupported video format. Please use: ${Object.values(this.supportedFormats).map(i=>i.name).join(", ")}`}:{valid:!1,error:"No file selected"}}validateFileAdvanced(e){return l(this,null,function*(){const t=this.validateFile(e);return t.valid?new Promise(i=>{const s=new FileReader;s.onload=n=>{const r=new Uint8Array(n.target.result),a=this.isVideoFile(r,e.type);i(a?{valid:!0}:{valid:!1,error:"File does not appear to be a valid video"})},s.onerror=()=>{i({valid:!1,error:"Could not read file"})},s.readAsArrayBuffer(e.slice(0,1024))}):t})}isVideoFile(e,t){const s={"video/mp4":[0,0,0,null,102,116,121,112],"video/webm":[26,69,223,163],"video/ogg":[79,103,103,83]}[t];if(!s)return!0;for(let n=0;n<s.length;n++)if(s[n]!==null&&e[n]!==s[n])return!1;return!0}showFileInfo(e){const t=document.getElementById("file-name"),i=document.getElementById("file-meta"),s=document.getElementById("file-status");if(t&&(t.textContent=e.name),i){const n=this.supportedFormats[e.type];i.textContent=`${n.name} • ${this.formatFileSize(e.size)}`}s&&(s.innerHTML='<span class="status-ready">✓ Ready to stream</span>')}showValidationInfo(){const e=document.getElementById("validation-info");e&&(e.style.display="block")}showValidationError(e){const t=document.getElementById("file-status");t&&(t.innerHTML=`<span class="status-error">✗ ${this.escapeHtml(e)}</span>`),this.showValidationInfo();const i=document.getElementById("start-streaming");i&&(i.disabled=!0)}clearFile(){this.selectedFile=null;const e=document.getElementById("movie-file-input");e&&(e.value="");const t=document.getElementById("validation-info");t&&(t.style.display="none"),this.hideUploadProgress(),console.log("📝 File selection cleared")}startStreaming(){return l(this,null,function*(){if(!(!this.selectedFile||this.isUploading)){this.isUploading=!0,this.showUploadProgress();try{yield this.simulateUpload(),this.onFileSelected&&this.onFileSelected({file:this.selectedFile,type:this.selectedFile.type,size:this.selectedFile.size,name:this.selectedFile.name}),console.log("🎬 Movie streaming started:",this.selectedFile.name)}catch(e){console.error("❌ Streaming failed:",e),this.showValidationError("Failed to start streaming: "+e.message)}finally{this.isUploading=!1,this.hideUploadProgress()}}})}simulateUpload(){return l(this,null,function*(){for(let t=0;t<=20;t++){const i=Math.round(t/20*100);this.updateProgress(i,t===0?"Preparing file...":t===20?"Ready to stream!":"Processing..."),yield new Promise(s=>setTimeout(s,100))}})}showUploadProgress(){const e=document.getElementById("upload-progress");e&&(e.style.display="block");const t=document.getElementById("start-streaming");t&&(t.disabled=!0,t.textContent="Processing...")}hideUploadProgress(){const e=document.getElementById("upload-progress");e&&(e.style.display="none");const t=document.getElementById("start-streaming");t&&(t.disabled=!this.selectedFile,t.textContent="Start Streaming")}updateProgress(e,t){const i=document.getElementById("progress-fill"),s=document.getElementById("progress-percent"),n=document.getElementById("progress-status");i&&(i.style.width=`${e}%`),s&&(s.textContent=`${e}%`),n&&(n.textContent=t)}formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+i[s]}escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}destroy(){this.selectedFile&&this.clearFile()}}class xt{constructor(){this.mediaSource=null,this.sourceBuffer=null,this.videoElement=null,this.file=null,this.isStreaming=!1,this.isPaused=!1,this.currentChunk=0,this.totalChunks=0,this.chunkSize=1024*1024,this.bufferTimeAhead=30,this.maxBufferTime=60,this.minBufferTime=5,this.chunks=[],this.bufferedRanges=[],this.eventListeners={},this.appendQueue=[],this.isAppending=!1,this.bufferSchedulerActive=!1,this.useFallbackMode=!1,this.stats={chunksLoaded:0,totalLoadTime:0,averageChunkTime:0,bufferHealth:100,stallCount:0,seekCount:0},this.supportedTypes=['video/mp4; codecs="avc1.42E01E,mp4a.40.2"','video/mp4; codecs="avc1.64001E,mp4a.40.2"','video/mp4; codecs="avc1.4D401E,mp4a.40.2"','video/webm; codecs="vp9,opus"','video/webm; codecs="vp8,vorbis"'],this.initializeCapabilities()}initializeCapabilities(){this.capabilities={mseSupported:this.checkMSESupport(),supportedMimeTypes:this.getSupportedMimeTypes(),maxSourceBuffers:this.getMaxSourceBuffers()},console.log("🎬 Streaming capabilities:",this.capabilities)}checkMSESupport(){return window.MediaSource?(MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')||console.warn("⚠️ MP4 H.264 support limited"),!0):(console.error("❌ Media Source Extensions not supported"),!1)}getSupportedMimeTypes(){return this.supportedTypes.filter(e=>MediaSource.isTypeSupported(e))}getMaxSourceBuffers(){try{return new MediaSource().sourceBuffers.length||16}catch(e){return 1}}initializeStreaming(s,n){return l(this,arguments,function*(e,t,i={}){if(e.size>100*1024*1024)return console.log("📦 Large file detected, using fallback streaming mode"),this.initializeFallbackStreaming(e,t,i);if(!this.capabilities.mseSupported)throw new Error("Media Source Extensions not supported in this browser");this.file=e,this.videoElement=t,this.chunkSize=i.chunkSize||this.chunkSize,this.bufferTimeAhead=i.bufferTimeAhead||this.bufferTimeAhead;const r=yield this.detectMimeType(e);if(this.currentMimeType=r,!this.capabilities.supportedMimeTypes.includes(r))return console.warn(`⚠️ Unsupported format ${r}, trying fallback mode`),this.initializeFallbackStreaming(e,t,i);this.totalChunks=Math.ceil(e.size/this.chunkSize),console.log(`🎬 Initializing streaming: ${this.totalChunks} chunks of ${this.formatBytes(this.chunkSize)}`);try{this.mediaSource=new MediaSource,this.setupMediaSourceEvents();const a=URL.createObjectURL(this.mediaSource);return this.videoElement.src=a,console.log(`📺 Video source set: ${a}`),this.setupVideoEvents(),new Promise((c,d)=>{this.mediaSource.addEventListener("sourceopen",()=>l(this,null,function*(){try{yield this.initializeSourceBuffer(r),yield this.startOptimizedStreaming(),c({duration:this.videoElement.duration,totalChunks:this.totalChunks,chunkSize:this.chunkSize,mimeType:r,mode:"mse"})}catch(h){console.error("❌ MSE initialization failed, switching to fallback:",h),this.cleanup();const p=yield this.initializeFallbackStreaming(e,t,i);c(p)}}),{once:!0}),this.mediaSource.addEventListener("error",()=>l(this,null,function*(){console.error("❌ MediaSource error, switching to fallback mode"),this.cleanup();const h=yield this.initializeFallbackStreaming(e,t,i);c(h)}),{once:!0})})}catch(a){return console.error("❌ Failed to initialize MSE, using fallback:",a),this.initializeFallbackStreaming(e,t,i)}})}initializeFallbackStreaming(s,n){return l(this,arguments,function*(e,t,i={}){console.log("🔄 Initializing fallback streaming mode"),this.file=e,this.videoElement=t,this.useFallbackMode=!0;const r=new Blob([e],{type:e.type||"video/mp4"}),a=URL.createObjectURL(r);return this.setupVideoEvents(),this.videoElement.src=a,new Promise(c=>{const d=()=>{this.videoElement.removeEventListener("loadedmetadata",d),console.log("✅ Fallback streaming ready"),this.isStreaming=!0,this.emit("ready"),c({duration:this.videoElement.duration,totalChunks:1,chunkSize:e.size,mimeType:e.type||"video/mp4",mode:"fallback"})},h=p=>{this.videoElement.removeEventListener("error",h),console.error("❌ Fallback streaming also failed:",p),c({duration:0,totalChunks:1,chunkSize:e.size,mimeType:e.type||"video/mp4",mode:"direct",error:"Video format not supported"})};this.videoElement.addEventListener("loadedmetadata",d),this.videoElement.addEventListener("error",h),setTimeout(()=>{this.isStreaming||(console.warn("⚠️ Metadata loading timeout, continuing anyway"),d())},5e3)})})}detectMimeType(e){return l(this,null,function*(){const t=["video/avi","video/wmv","video/flv"];if(e.type&&t.includes(e.type))throw new Error("Unsupported video format");if(e.type&&this.capabilities.supportedMimeTypes.includes(e.type))return e.type;const i=yield this.readFileHeader(e,64);if(this.isMP4Header(i)){const s=['video/mp4; codecs="avc1.42E01E,mp4a.40.2"','video/mp4; codecs="avc1.4D401E,mp4a.40.2"','video/mp4; codecs="avc1.64001E,mp4a.40.2"'];for(const n of s)if(MediaSource.isTypeSupported(n))return n}return this.isWebMHeader(i)?'video/webm; codecs="vp9,opus"':'video/mp4; codecs="avc1.42E01E,mp4a.40.2"'})}readFileHeader(e,t){return l(this,null,function*(){return new Promise((i,s)=>{const n=new FileReader;n.onload=r=>i(new Uint8Array(r.target.result)),n.onerror=s,n.readAsArrayBuffer(e.slice(0,t))})})}isMP4Header(e){for(let t=0;t<e.length-4;t++)if(e[t]===102&&e[t+1]===116&&e[t+2]===121&&e[t+3]===112)return!0;return!1}isWebMHeader(e){return e[0]===26&&e[1]===69&&e[2]===223&&e[3]===163}setupMediaSourceEvents(){this.mediaSource.addEventListener("sourceopen",()=>{console.log("📺 MediaSource opened"),this.emit("sourceopen")}),this.mediaSource.addEventListener("sourceended",()=>{console.log("📺 MediaSource ended"),this.emit("sourceended")}),this.mediaSource.addEventListener("error",e=>{console.error("❌ MediaSource error:",e),this.emit("error",e)})}setupVideoEvents(){this.videoElement.addEventListener("progress",()=>{this.updateBufferedRanges(),this.monitorBufferHealth()}),this.videoElement.addEventListener("loadedmetadata",()=>{console.log(`📊 Video metadata loaded - Duration: ${this.videoElement.duration}s`),this.emit("metadata-loaded",{duration:this.videoElement.duration,videoWidth:this.videoElement.videoWidth,videoHeight:this.videoElement.videoHeight})}),this.videoElement.addEventListener("waiting",()=>{console.log("⏳ Video waiting for data"),this.stats.stallCount++,this.emit("buffering",!0)}),this.videoElement.addEventListener("playing",()=>{console.log("▶️ Video playing"),this.emit("buffering",!1)}),this.videoElement.addEventListener("seeking",()=>{this.stats.seekCount++,this.useFallbackMode||this.handleSeek()}),this.videoElement.addEventListener("error",e=>{console.error("❌ Video error:",e),this.emit("error",e)}),this.videoElement.addEventListener("timeupdate",()=>{this.emit("timeupdate",{currentTime:this.videoElement.currentTime,duration:this.videoElement.duration,buffered:this.getBufferedPercent()})})}initializeSourceBuffer(e){return l(this,null,function*(){try{this.sourceBuffer=this.mediaSource.addSourceBuffer(e),this.sourceBuffer.addEventListener("updateend",()=>{this.isAppending=!1,this.processAppendQueue(),this.handleBufferUpdate()}),this.sourceBuffer.addEventListener("error",t=>{console.error("❌ SourceBuffer error:",t),this.handleSourceBufferError(t)}),console.log(`📺 SourceBuffer initialized with ${e}`)}catch(t){throw new Error(`Failed to initialize SourceBuffer: ${t.message}`)}})}startOptimizedStreaming(){return l(this,null,function*(){if(!this.isStreaming){this.isStreaming=!0,this.currentChunk=0,this.bufferSchedulerActive=!0,console.log("🚀 Starting optimized streaming...");try{yield this.loadInitialChunks(),this.emit("ready"),this.startBufferScheduler()}catch(e){throw console.error("❌ Failed to start streaming:",e),e}}})}loadInitialChunks(){return l(this,null,function*(){console.log("📦 Loading initial chunks...");const e=Math.min(3,this.totalChunks);for(let t=0;t<e;t++)try{const i=yield this.loadChunk(t);if(yield this.queueAppend(i,`initial-chunk-${t}`),this.currentChunk=t+1,t===0&&this.videoElement.readyState>=2){console.log("✅ Video ready for playback");break}}catch(i){if(console.error(`❌ Failed to load initial chunk ${t}:`,i),t===0)throw new Error("Failed to load initial video data");break}})}loadChunk(e){return l(this,null,function*(){const t=e*this.chunkSize,i=Math.min(t+this.chunkSize,this.file.size);return new Promise((s,n)=>{const r=new FileReader;r.onload=a=>{this.stats.chunksLoaded++,s(a.target.result)},r.onerror=n,r.readAsArrayBuffer(this.file.slice(t,i))})})}queueAppend(e,t){return l(this,null,function*(){return new Promise((i,s)=>{this.appendQueue.push({data:e,chunkId:t,resolve:i,reject:s}),this.processAppendQueue()})})}processAppendQueue(){if(this.isAppending||this.appendQueue.length===0||!this.sourceBuffer||this.sourceBuffer.updating||!this.mediaSource||this.mediaSource.readyState!=="open")return;const e=this.appendQueue.shift();this.isAppending=!0;try{console.log(`⬆️ Appending ${e.chunkId} (${e.data.byteLength} bytes)`),this.sourceBuffer.appendBuffer(e.data),this.sourceBuffer.addEventListener("updateend",()=>{console.log(`✅ ${e.chunkId} appended successfully`),e.resolve()},{once:!0}),this.sourceBuffer.addEventListener("error",t=>{console.error(`❌ Failed to append ${e.chunkId}:`,t),e.reject(new Error(`Failed to append ${e.chunkId}`))},{once:!0})}catch(t){console.error(`❌ Exception appending ${e.chunkId}:`,t),this.isAppending=!1,e.reject(t),this.mediaSource.readyState!=="open"&&(this.appendQueue.forEach(i=>i.reject(new Error("MediaSource closed"))),this.appendQueue=[],this.bufferSchedulerActive=!1)}}startBufferScheduler(){if(!this.bufferSchedulerActive)return;const e=()=>{!this.bufferSchedulerActive||!this.isStreaming||this.checkAndBufferNext().then(()=>{this.bufferSchedulerActive&&setTimeout(e,1e3)}).catch(t=>{console.warn("⚠️ Buffer scheduler error:",t),this.bufferSchedulerActive&&setTimeout(e,2e3)})};e()}checkAndBufferNext(){return l(this,null,function*(){if(!this.videoElement||this.useFallbackMode||!this.mediaSource||this.mediaSource.readyState!=="open"||this.currentChunk>=this.totalChunks)return;const e=this.videoElement.currentTime;if(this.getBufferedTimeAhead(e)<this.bufferTimeAhead)try{const i=yield this.loadChunk(this.currentChunk);yield this.queueAppend(i,`chunk-${this.currentChunk}`),this.currentChunk++}catch(i){console.warn(`⚠️ Failed to buffer chunk ${this.currentChunk}:`,i)}})}handleBufferUpdate(){if(this.sourceBuffer&&this.sourceBuffer.buffered.length>0){const e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++)e.push({start:this.sourceBuffer.buffered.start(t),end:this.sourceBuffer.buffered.end(t)});console.log("📊 Buffer ranges:",e)}}handleSourceBufferError(e){if(console.error("🔄 Handling SourceBuffer error:",e),this.bufferSchedulerActive=!1,this.appendQueue=[],this.mediaSource&&this.mediaSource.readyState==="open")try{this.mediaSource.endOfStream()}catch(t){console.warn("⚠️ Could not end stream:",t)}this.emit("error",new Error("Streaming error occurred"))}handleSeek(){const e=this.videoElement.currentTime;console.log(`⏩ Seeking to ${e.toFixed(2)}s`);const t=this.videoElement.duration||0;if(t>0){const i=Math.floor(e/t*this.totalChunks);this.currentChunk=Math.max(i,this.currentChunk)}}monitorBufferHealth(){if(!this.videoElement||this.useFallbackMode)return;const e=this.videoElement.currentTime,t=this.getBufferedTimeAhead(e);this.stats.bufferHealth=Math.min(100,t/this.bufferTimeAhead*100),this.emit("buffer-health",{health:this.stats.bufferHealth,bufferedAhead:t,recommended:this.bufferTimeAhead})}getBufferedTimeAhead(e){if(!this.videoElement.buffered.length)return 0;for(let t=0;t<this.videoElement.buffered.length;t++){const i=this.videoElement.buffered.start(t),s=this.videoElement.buffered.end(t);if(e>=i&&e<=s)return s-e}return 0}getBufferedPercent(){if(!this.videoElement.buffered.length||!this.videoElement.duration)return 0;let e=0;for(let t=0;t<this.videoElement.buffered.length;t++)e+=this.videoElement.buffered.end(t)-this.videoElement.buffered.start(t);return e/this.videoElement.duration*100}updateBufferedRanges(){if(this.bufferedRanges=[],!!this.videoElement.buffered)for(let e=0;e<this.videoElement.buffered.length;e++)this.bufferedRanges.push({start:this.videoElement.buffered.start(e),end:this.videoElement.buffered.end(e)})}play(){return l(this,null,function*(){if(this.videoElement)try{yield this.videoElement.play(),this.isPaused=!1,console.log("▶️ Playback started")}catch(e){console.error("❌ Play failed:",e),this.emit("error",e)}})}pause(){this.videoElement&&(this.videoElement.pause(),this.isPaused=!0,console.log("⏸️ Playback paused"))}seek(e){if(!this.videoElement)return;const t=Math.max(0,Math.min(this.videoElement.duration||0,e));this.videoElement.currentTime=t,console.log(`⏩ Seeking to ${t.toFixed(2)}s`)}setVolume(e){this.videoElement&&(this.videoElement.volume=Math.max(0,Math.min(1,e)))}getStats(){var e,t;return M(S({},this.stats),{isStreaming:this.isStreaming,currentChunk:this.currentChunk,totalChunks:this.totalChunks,bufferedPercent:this.getBufferedPercent(),currentTime:((e=this.videoElement)==null?void 0:e.currentTime)||0,duration:((t=this.videoElement)==null?void 0:t.duration)||0,mode:this.useFallbackMode?"fallback":"mse"})}cleanup(){if(this.bufferSchedulerActive=!1,this.appendQueue.forEach(e=>e.reject(new Error("Streaming stopped"))),this.appendQueue=[],this.mediaSource&&this.mediaSource.readyState==="open")try{this.mediaSource.endOfStream()}catch(e){console.warn("⚠️ Could not end MediaSource stream:",e)}this.sourceBuffer=null,this.mediaSource=null}stop(){this.isStreaming=!1,this.isPaused=!1,this.bufferSchedulerActive=!1,this.videoElement&&(this.videoElement.pause(),this.useFallbackMode&&this.videoElement.src.startsWith("blob:")&&URL.revokeObjectURL(this.videoElement.src),this.videoElement.src=""),this.cleanup(),this.chunks=[],this.currentChunk=0,this.useFallbackMode=!1,console.log("⏹️ Streaming stopped and cleaned up")}on(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}off(e,t){if(!this.eventListeners[e])return;const i=this.eventListeners[e].indexOf(t);i>-1&&this.eventListeners[e].splice(i,1)}emit(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(i=>{try{i(t)}catch(s){console.error(`❌ Event callback error for ${e}:`,s)}})}formatBytes(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+i[s]}}class At{constructor(e){this.socketClient=e,this.serverTimeOffset=0,this.networkLatency=0,this.clockSyncSamples=[],this.maxSamples=10,this.syncPrecision=50,this.isCalibrating=!1,this.calibrationInterval=null,this.lastSyncTime=0,this.driftTolerance=100,this.syncHistory=[],this.setupSyncEventListeners(),this.startClockCalibration()}setupSyncEventListeners(){this.socketClient.on("time-sync-response",e=>{this.handleTimeSyncResponse(e)}),this.socketClient.on("precision-sync",e=>{this.handlePrecisionSync(e)})}startClockCalibration(){this.calibrateServerTime(),this.calibrationInterval=setInterval(()=>{this.calibrateServerTime()},3e4),console.log("🕐 Started clock calibration with server")}calibrateServerTime(){return l(this,null,function*(){if(!this.isCalibrating){this.isCalibrating=!0;try{const e=[];for(let t=0;t<5;t++){const i=yield this.measureLatency();i&&e.push(i),yield new Promise(s=>setTimeout(s,100))}e.length>0&&this.processSyncSamples(e)}catch(e){console.error("❌ Clock calibration failed:",e)}finally{this.isCalibrating=!1}}})}measureLatency(){return new Promise(e=>{const t=performance.now(),i=Date.now(),s=r=>{const c=performance.now()-t;e({roundTripTime:c,clientSendTime:i,serverTime:r.serverTime,clientReceiveTime:Date.now()}),this.socketClient.off("time-sync-response",s)},n=setTimeout(()=>{this.socketClient.off("time-sync-response",s),console.warn("⚠️ Time sync request timed out"),e(null)},2e3);this.socketClient.on("time-sync-response",r=>{clearTimeout(n),s(r)}),this.socketClient.emit("time-sync-request",{clientTime:i})})}processSyncSamples(e){this.clockSyncSamples.push(...e),this.clockSyncSamples.length>this.maxSamples&&(this.clockSyncSamples=this.clockSyncSamples.slice(-this.maxSamples));const t=this.clockSyncSamples.map(n=>n.roundTripTime).sort((n,r)=>n-r);this.networkLatency=t[Math.floor(t.length/2)];const i=this.clockSyncSamples.reduce((n,r)=>r.roundTripTime<n.roundTripTime?r:n),s=i.roundTripTime/2;this.serverTimeOffset=i.serverTime-(i.clientSendTime+s),console.log(`🕐 Clock sync updated: latency=${this.networkLatency.toFixed(1)}ms, offset=${this.serverTimeOffset.toFixed(1)}ms`),this.emitSyncStats()}getServerTime(){return Date.now()+this.serverTimeOffset}calculatePrecisionSync(e,t,i){const s=this.getServerTime(),n=s-t,r=i+n,a=this.networkLatency/2;return{targetTime:r,latencyCompensation:a,timeDrift:n,serverTime:s,syncAccuracy:Math.abs(n)}}performFramePerfectSync(e,t,i){return l(this,null,function*(){if(!e||!i)return!1;const s=this.calculatePrecisionSync(t,i.timestamp||this.getServerTime(),i.currentTime||0);console.log(`🎯 Frame-perfect sync: ${t}`,{targetTime:s.targetTime,drift:s.timeDrift,accuracy:s.syncAccuracy});try{switch(t){case"play":return yield this.syncPlay(e,s,i);case"pause":return this.syncPause(e,s);case"seek":return yield this.syncSeek(e,s,i);default:return console.warn("Unknown sync action:",t),!1}}catch(n){return console.error("❌ Frame-perfect sync failed:",n),!1}})}syncPlay(e,t,i){return l(this,null,function*(){Math.abs(e.currentTime-t.targetTime)>.1&&(e.currentTime=t.targetTime);const s=Math.max(0,t.latencyCompensation-t.timeDrift);return s>5&&(yield new Promise(n=>setTimeout(n,s))),yield e.play(),this.recordSyncEvent("play",t),!0})}syncPause(e,t){return e.pause(),Math.abs(e.currentTime-t.targetTime)>.1&&(e.currentTime=t.targetTime),this.recordSyncEvent("pause",t),!0}syncSeek(e,t,i){return l(this,null,function*(){const s=i.currentTime||t.targetTime;return e.currentTime=s,new Promise(n=>{const r=()=>{e.removeEventListener("seeked",r),this.recordSyncEvent("seek",t),n(!0)};e.addEventListener("seeked",r),setTimeout(()=>{e.removeEventListener("seeked",r),n(!1)},1e3)})})}recordSyncEvent(e,t){this.syncHistory.push({action:e,timestamp:Date.now(),accuracy:t.syncAccuracy,drift:t.timeDrift,latency:this.networkLatency}),this.syncHistory.length>50&&(this.syncHistory=this.syncHistory.slice(-50)),this.lastSyncTime=Date.now()}detectSyncDrift(){if(this.syncHistory.length<3)return null;const e=this.syncHistory.slice(-5),t=e.reduce((n,r)=>n+Math.abs(r.drift),0)/e.length,i=e.reduce((n,r)=>n+r.accuracy,0)/e.length,s=t>this.driftTolerance;return{averageDrift:t,averageAccuracy:i,needsCorrection:s,quality:i<50?"excellent":i<100?"good":"fair"}}getSyncStats(){const e=this.detectSyncDrift();return{networkLatency:this.networkLatency,serverTimeOffset:this.serverTimeOffset,syncPrecision:this.syncPrecision,syncHistory:this.syncHistory.length,drift:e,lastSyncTime:this.lastSyncTime,isCalibrated:this.clockSyncSamples.length>0}}emitSyncStats(){const e=this.getSyncStats();typeof window!="undefined"&&window.dispatchEvent(new CustomEvent("sync-stats-updated",{detail:e}))}handleTimeSyncResponse(e){console.log("🕐 Time sync response received")}handlePrecisionSync(e){console.log("🎯 Precision sync command received:",e)}destroy(){this.calibrationInterval&&(clearInterval(this.calibrationInterval),this.calibrationInterval=null),this.clockSyncSamples=[],this.syncHistory=[],console.log("🕐 Synchronization manager destroyed")}}class we{constructor(e,t){this.socketClient=e,this.onStateChange=t,this.streamingManager=new xt,this.syncManager=new At(e),this.container=null,this.videoElement=null,this.controlsContainer=null,this.isInitialized=!1,this.isHost=!1,this.currentFile=null,this.isPlaying=!1,this.isMuted=!1,this.volume=1,this.currentTime=0,this.duration=0,this.bufferedPercent=0,this.isFullscreen=!1,this.controlsVisible=!0,this.controlsTimer=null,this.isDragging=!1,this.wasPlayingBeforeDrag=!1,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this),this.hideControlsDelayed=this.hideControlsDelayed.bind(this),this.participantTimer=null,this.participantStartTime=null,this.lastLoggedTime=-1,this.setupStreamingEvents(),this.setupSyncStatsListener()}setupStreamingEvents(){this.streamingManager.on("ready",()=>{console.log("🎬 Video ready for playback"),this.hideError(),this.updatePlayerState(),this.emit("ready")}),this.streamingManager.on("timeupdate",e=>{this.currentTime=e.currentTime,this.duration=e.duration,this.bufferedPercent=e.buffered,this.updateTimeDisplay(),this.updateProgressBar()}),this.streamingManager.on("buffering",e=>{this.showBufferingIndicator(e)}),this.streamingManager.on("buffer-health",e=>{this.updateBufferIndicator(e)}),this.streamingManager.on("chunk-loaded",e=>{this.updateLoadingProgress(e)}),this.streamingManager.on("error",e=>{console.error("❌ Streaming error:",e);let t="Streaming error: "+e.message;e.message&&e.message.includes("MediaSource")?t="Video file format error: This video file may not be compatible with browser streaming. Try a different MP4 file or convert to a web-optimized format.":e.message&&e.message.includes("SourceBuffer")?t="Video streaming failed: There was a problem loading the video data. Please try again or use a smaller file.":e.message&&e.message.includes("Format error")&&(t="Video format error: This video format is not supported. Please use an MP4 file with H.264 video and AAC audio."),this.videoElement.readyState<2&&!this.videoElement.duration?this.showError(t):console.log("🔄 Streaming error occurred but video is playable, not showing error UI")}),this.streamingManager.on("playing",()=>{this.hideError()})}setupSyncStatsListener(){typeof window!="undefined"&&window.addEventListener("sync-stats-updated",e=>{this.updateSyncQualityIndicator(e.detail)})}initializeWithFile(e,t,i=!1){return l(this,null,function*(){if(this.currentFile=e,this.container=t,this.isHost=i,!t)throw new Error("Container element is required");this.createPlayerElements(),this.setupEventListeners();try{console.log("🎬 Initializing video player with file:",{name:e.name,size:this.formatBytes(e.size),type:e.type}),this.updateLoadingStatus("Analyzing video file...");const s=yield this.streamingManager.initializeStreaming(e,this.videoElement,{chunkSize:this.calculateOptimalChunkSize(e.size),bufferTimeAhead:30});console.log("🎬 Streaming initialization completed:",s),this.updateLoadingStatus("Loading video metadata..."),yield this.waitForMetadata(5e3),this.isInitialized=!0,this.updatePlayerState(),console.log("✅ Video player initialized successfully:",{duration:this.duration,width:this.videoElement.videoWidth,height:this.videoElement.videoHeight,readyState:this.videoElement.readyState}),this.duration&&!isNaN(this.duration)&&this.hideLoadingOverlay()}catch(s){throw console.error("❌ Failed to initialize video player:",s),this.showError("Failed to load video: "+s.message),s}})}calculateOptimalChunkSize(e){return e<50*1024*1024?512*1024:e<200*1024*1024?1024*1024:e<1024*1024*1024?2*1024*1024:4*1024*1024}initializeAsParticipant(e,t){return l(this,null,function*(){if(this.container=e,this.isHost=!1,!e)throw new Error("Container element is required");console.log("🎬 Initializing participant video player:",t),this.participantMovieState=t,this.duration=t.duration||0,this.currentTime=t.currentTime||0,this.createPlayerElements(),this.setupEventListeners(),this.disableParticipantControls(),this.setupParticipantVideoPlayer(t),this.isInitialized=!0,this.updatePlayerState(),console.log("✅ Participant video player initialized with metadata:",{duration:this.duration,title:t.title})})}setupParticipantVideoPlayer(e){this.videoElement&&e.duration&&(Object.defineProperty(this.videoElement,"duration",{value:e.duration,writable:!0,configurable:!0}),Object.defineProperty(this.videoElement,"currentTime",{value:e.currentTime||0,writable:!0,configurable:!0}),this.updateTimeDisplay(),this.hideLoadingOverlay()),this.showParticipantMessage(e),console.log("🎬 Virtual video player setup complete for participant")}disableParticipantControls(){if(this.isHost)return;const e=this.container.querySelector("#play-pause-btn"),t=this.container.querySelector("#progress-container"),i=this.container.querySelector("#sync-btn");e&&(e.disabled=!0,e.style.opacity="0.6",e.title="Only host can control playback"),t&&(t.style.pointerEvents="none",t.style.opacity="0.8",t.title="Only host can seek"),i&&(i.style.display="none"),this.participantControlsDisabled=!0,console.log("🔒 Participant playback controls disabled")}showParticipantMessage(e){const t=this.container.querySelector(".loading-overlay");t&&(e.duration&&e.duration>0?(t.innerHTML=`
          <div class="loading-content">
            <div class="movie-info-participant">
              <h3>🎬 ${this.escapeHtml(e.title||"Movie Selected")}</h3>
              <div class="movie-details">
                <p><strong>Duration:</strong> ${this.formatTime(e.duration)}</p>
                <p><strong>Resolution:</strong> ${e.width||"?"}×${e.height||"?"}</p>
                <p><strong>Size:</strong> ${this.formatBytes(e.size||0)}</p>
              </div>
              <div class="participant-status">
                <p>🎯 <strong>Frame-perfect sync enabled</strong></p>
                <p>📡 Synchronized with host playback</p>
                <small style="color: rgba(255,255,255,0.7);">
                  Video streaming from host to participants coming soon!
                </small>
              </div>
            </div>
          </div>
        `,setTimeout(()=>{t&&(t.style.display="none")},3e3)):t.innerHTML=`
          <div class="loading-content">
            <div class="movie-info-participant">
              <h3>🎬 ${this.escapeHtml(e.title||"Movie Selected")}</h3>
              <p>The host is streaming: <strong>${this.escapeHtml(e.title||"Unknown Movie")}</strong></p>
              <p>⏳ Waiting for host to start playback...</p>
              <div class="sync-info" style="margin-top: 12px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                <p>📡 Frame-perfect synchronization ready</p>
                <small>Video streaming implementation in progress</small>
              </div>
            </div>
          </div>
        `,t.style.display="flex")}syncWithHost(e,t){return l(this,null,function*(){if(!this.isHost){console.log(`🎯 Frame-perfect sync with host: ${e}`,t),this.participantMovieState=S(S({},this.participantMovieState),t);try{switch(e){case"play":this.isPlaying=!0,this.currentTime=t.currentTime||0,this.startParticipantTimer(),this.videoElement&&this.duration>0&&Object.defineProperty(this.videoElement,"currentTime",{value:this.currentTime,writable:!0,configurable:!0});break;case"pause":this.isPlaying=!1,this.currentTime=t.currentTime||0,this.stopParticipantTimer(),this.videoElement&&this.duration>0&&Object.defineProperty(this.videoElement,"currentTime",{value:this.currentTime,writable:!0,configurable:!0});break;case"seek":this.currentTime=t.currentTime||0,this.isPlaying&&this.startParticipantTimer(),this.videoElement&&this.duration>0&&Object.defineProperty(this.videoElement,"currentTime",{value:this.currentTime,writable:!0,configurable:!0});break}this.updatePlayerState(),this.duration>0&&this.hideLoadingOverlay(),console.log(`✅ Virtual sync completed: ${e} at ${this.formatTime(this.currentTime)}`),this.showParticipantSyncStatus(e,t)}catch(i){console.error("❌ Failed to sync with host:",i),this.showParticipantSyncStatus(e,t)}}})}basicSyncWithHost(e,t){return l(this,null,function*(){switch(e){case"play":t.currentTime!==void 0&&(this.videoElement.currentTime=t.currentTime),yield this.videoElement.play(),this.isPlaying=!0;break;case"pause":this.videoElement.pause(),this.isPlaying=!1;break;case"seek":t.currentTime!==void 0&&(this.videoElement.currentTime=t.currentTime);break;default:console.warn("Unknown sync action:",e)}})}showParticipantSyncStatus(e,t){var s;if(this.duration>0){this.updatePlayPauseButton();return}const i=this.container.querySelector(".loading-overlay");if(i){const n=this.formatTime(t.currentTime||0),r=this.formatTime(t.duration||0),a={play:"▶️ Playing",pause:"⏸️ Paused",seek:"⏩ Seeking",sync:"🔄 Syncing"}[e]||e;i.innerHTML=`
        <div class="loading-content">
          <div class="movie-info-participant">
            <h3>🎬 ${this.escapeHtml(t.title||"Movie Streaming")}</h3>
            <div class="sync-status-main">
              <p><strong>Host Status:</strong> ${a}</p>
              <p><strong>Time:</strong> ${n} / ${r}</p>
            </div>
            <div class="sync-status">
              <p>🎯 <strong>Frame-perfect sync active</strong></p>
              <p>📡 Latency: ${Math.round(((s=this.syncManager)==null?void 0:s.networkLatency)||0)}ms</p>
              <small style="color: rgba(255,255,255,0.7);">
                Video stream from host coming soon!
              </small>
            </div>
          </div>
        </div>
      `,i.style.display="flex"}this.isPlaying=e==="play",this.currentTime=t.currentTime||0,this.updatePlayPauseButton()}startParticipantTimer(){if(this.isHost)return;this.stopParticipantTimer(),console.log(`🕐 Starting participant timer from ${this.formatTime(this.currentTime)} / ${this.formatTime(this.duration)}`),this.participantStartTime=Date.now();const e=this.currentTime;this.participantTimer=setInterval(()=>{if(this.isPlaying&&this.duration>0){const t=(Date.now()-this.participantStartTime)/1e3;if(this.currentTime=e+t,this.currentTime>=this.duration){this.currentTime=this.duration,this.isPlaying=!1,this.stopParticipantTimer(),console.log("🕐 Participant timer reached end");return}if(this.videoElement)try{this.videoElement.currentTime=this.currentTime}catch(i){Object.defineProperty(this.videoElement,"currentTime",{value:this.currentTime,writable:!0,configurable:!0})}this.updateTimeDisplay(),this.updateProgressBar(),Math.floor(this.currentTime)%2===0&&Math.floor(this.currentTime)!==this.lastLoggedTime&&(this.lastLoggedTime=Math.floor(this.currentTime),console.log(`🕐 Timer: ${this.formatTime(this.currentTime)} / ${this.formatTime(this.duration)}`))}else this.stopParticipantTimer()},100),console.log("🕐 Started participant virtual playback timer")}stopParticipantTimer(){this.participantTimer&&(clearInterval(this.participantTimer),this.participantTimer=null,this.participantStartTime=null,console.log("🕐 Stopped participant virtual playback timer"))}createPlayerElements(){this.container.innerHTML=this.renderPlayer(),this.videoElement=this.container.querySelector("#video-element"),this.controlsContainer=this.container.querySelector("#video-controls"),this.videoElement.playsInline=!0,this.videoElement.preload="metadata",this.videoElement.controls=!1,this.videoElement.muted=!1,this.videoElement.autoplay=!1}renderPlayer(){return`
      <div class="video-player" id="video-player">
        <div class="video-container">
          <video id="video-element" class="video-element">
            Your browser does not support the video tag.
          </video>
          
          <!-- Loading overlay -->
          <div class="video-overlay loading-overlay" id="loading-overlay">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading video...</div>
              <div class="loading-progress">
                <div class="progress-bar">
                  <div class="progress-fill" id="loading-progress-fill"></div>
                </div>
                <div class="progress-text" id="loading-progress-text">0%</div>
              </div>
            </div>
          </div>
          
          <!-- Buffering overlay -->
          <div class="video-overlay buffering-overlay" id="buffering-overlay" style="display: none;">
            <div class="buffering-spinner"></div>
          </div>
          
          <!-- Error overlay -->
          <div class="video-overlay error-overlay" id="error-overlay" style="display: none;">
            <div class="error-content">
              <div class="error-icon">⚠️</div>
              <div class="error-message" id="error-message"></div>
              <button class="btn btn-primary" id="retry-btn">Retry</button>
            </div>
          </div>
          
          <!-- Video controls -->
          <div class="video-controls" id="video-controls">
            <div class="controls-background"></div>
            
            <!-- Progress bar -->
            <div class="progress-container" id="progress-container">
              <div class="progress-track">
                <div class="progress-buffered" id="progress-buffered"></div>
                <div class="progress-played" id="progress-played"></div>
                <div class="progress-thumb" id="progress-thumb"></div>
              </div>
            </div>
            
            <!-- Control buttons -->
            <div class="controls-row">
              <div class="controls-left">
                <button class="control-btn play-pause-btn" id="play-pause-btn" title="Play/Pause">
                  <svg class="play-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                  </svg>
                  <svg class="pause-icon" viewBox="0 0 24 24" width="20" height="20" style="display: none;">
                    <path fill="currentColor" d="M14,19H18V5H14M6,19H10V5H6V19Z" />
                  </svg>
                </button>
                
                <div class="volume-container">
                  <button class="control-btn volume-btn" id="volume-btn" title="Mute/Unmute">
                    <svg class="volume-icon" viewBox="0 0 24 24" width="20" height="20">
                      <path fill="currentColor" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
                    </svg>
                    <svg class="mute-icon" viewBox="0 0 24 24" width="20" height="20" style="display: none;">
                      <path fill="currentColor" d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.52C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" />
                    </svg>
                  </button>
                  <div class="volume-slider" id="volume-slider">
                    <div class="volume-track">
                      <div class="volume-fill" id="volume-fill"></div>
                      <div class="volume-thumb" id="volume-thumb"></div>
                    </div>
                  </div>
                </div>
                
                <div class="time-display" id="time-display">
                  <span class="current-time">0:00</span>
                  <span class="time-separator">/</span>
                  <span class="duration-time">0:00</span>
                </div>
              </div>
              
              <div class="controls-right">
                <div class="buffer-health" id="buffer-health" title="Buffer Health">
                  <div class="buffer-indicator"></div>
                </div>
                
                <div class="sync-quality" id="sync-quality" title="Synchronization Quality" style="display: none;">
                  <div class="sync-indicator"></div>
                  <span class="sync-text">SYNC</span>
                </div>
                
                ${this.isHost?`
                  <div class="host-controls">
                    <div class="host-indicator" title="You are controlling playback for all participants">
                      <svg viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25Z" />
                      </svg>
                      <span class="host-text">HOST</span>
                    </div>
                    <button class="control-btn sync-btn" id="sync-btn" title="Sync playback with all participants">
                      <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor" d="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z" />
                      </svg>
                    </button>
                  </div>
                `:`
                  <div class="participant-indicator" title="Playback is controlled by the host">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                      <path fill="currentColor" d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,7V9H21M15,15H21V13H15V15M11,22A2,2 0 0,1 9,20V14A2,2 0 0,1 11,12H13A2,2 0 0,1 15,14V20A2,2 0 0,1 13,22H11Z" />
                    </svg>
                    <span class="participant-text">VIEWER</span>
                  </div>
                `}
                
                <button class="control-btn fullscreen-btn" id="fullscreen-btn" title="Fullscreen">
                  <svg class="fullscreen-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z" />
                  </svg>
                  <svg class="fullscreen-exit-icon" viewBox="0 0 24 24" width="20" height="20" style="display: none;">
                    <path fill="currentColor" d="M14,14H19V16H16V19H14V14M5,14H10V19H8V16H5V14M8,5H10V10H5V8H8V5M19,8V10H14V5H16V8H19Z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `}setupEventListeners(){this.videoElement.addEventListener("loadedmetadata",()=>{console.log("🎬 Video metadata loaded:",{duration:this.videoElement.duration,width:this.videoElement.videoWidth,height:this.videoElement.videoHeight,readyState:this.videoElement.readyState}),this.duration=this.videoElement.duration,this.updateTimeDisplay(),this.hideLoadingOverlay(),this.hideError(),this.emit("metadata-loaded",{duration:this.duration,width:this.videoElement.videoWidth,height:this.videoElement.videoHeight})}),this.videoElement.addEventListener("loadeddata",()=>{console.log("🎬 Video data loaded, readyState:",this.videoElement.readyState),this.videoElement.duration&&!isNaN(this.videoElement.duration)&&(this.duration=this.videoElement.duration,this.updateTimeDisplay(),this.hideLoadingOverlay(),this.hideError())}),this.videoElement.addEventListener("durationchange",()=>{console.log("🎬 Video duration changed:",this.videoElement.duration),this.videoElement.duration&&!isNaN(this.videoElement.duration)&&(this.duration=this.videoElement.duration,this.updateTimeDisplay(),this.hideLoadingOverlay(),this.hideError())}),this.videoElement.addEventListener("play",()=>{this.isPlaying=!0,this.updatePlayPauseButton(),this.hideError(),this.notifyStateChange()}),this.videoElement.addEventListener("pause",()=>{this.isPlaying=!1,this.updatePlayPauseButton(),this.notifyStateChange()}),this.videoElement.addEventListener("volumechange",()=>{this.volume=this.videoElement.volume,this.isMuted=this.videoElement.muted,this.updateVolumeControls()});const e=this.container.querySelector("#play-pause-btn");e==null||e.addEventListener("click",()=>this.togglePlayPause());const t=this.container.querySelector("#volume-btn");t==null||t.addEventListener("click",()=>this.toggleMute());const i=this.container.querySelector("#fullscreen-btn");i==null||i.addEventListener("click",()=>this.toggleFullscreen());const s=this.container.querySelector("#sync-btn");s==null||s.addEventListener("click",()=>this.syncWithParticipants());const n=this.container.querySelector("#retry-btn");n==null||n.addEventListener("click",()=>this.retry()),this.setupProgressBarEvents(),this.setupVolumeSliderEvents(),this.container.addEventListener("mousemove",this.handleMouseMove),this.container.addEventListener("mouseleave",()=>this.hideControls()),document.addEventListener("keydown",this.handleKeyPress),document.addEventListener("fullscreenchange",()=>{this.isFullscreen=!!document.fullscreenElement,this.updateFullscreenButton()})}setupProgressBarEvents(){const e=this.container.querySelector("#progress-container"),t=this.container.querySelector("#progress-thumb");let i=!1;e.addEventListener("click",s=>{if(i)return;const n=e.getBoundingClientRect(),a=(s.clientX-n.left)/n.width*this.duration;this.seek(a)}),t.addEventListener("mousedown",s=>{s.preventDefault(),i=!0,this.wasPlayingBeforeDrag=this.isPlaying,this.isPlaying&&this.pause();const n=a=>{const c=e.getBoundingClientRect(),h=Math.max(0,Math.min(1,(a.clientX-c.left)/c.width))*this.duration;this.videoElement.currentTime=h,this.updateProgressBar()},r=()=>{i=!1,this.wasPlayingBeforeDrag&&this.play(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)})}setupVolumeSliderEvents(){const e=this.container.querySelector("#volume-slider"),t=this.container.querySelector("#volume-thumb");let i=!1;e.addEventListener("click",s=>{if(i)return;const n=e.getBoundingClientRect(),r=(s.clientX-n.left)/n.width;this.setVolume(r)}),t.addEventListener("mousedown",s=>{s.preventDefault(),i=!0;const n=a=>{const c=e.getBoundingClientRect(),d=Math.max(0,Math.min(1,(a.clientX-c.left)/c.width));this.setVolume(d)},r=()=>{i=!1,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)})}handleMouseMove(){this.showControls(),this.hideControlsDelayed()}handleKeyPress(e){if(!this.isInitialized)return;const t=document.activeElement;if(t&&["INPUT","TEXTAREA"].includes(t.tagName))return;if(["Space","ArrowLeft","ArrowRight"].includes(e.code)&&this.participantControlsDisabled){console.log("🔒 Playback keyboard shortcuts disabled for participants");return}switch(e.code){case"Space":e.preventDefault(),this.togglePlayPause();break;case"ArrowLeft":e.preventDefault(),this.seek(this.currentTime-10);break;case"ArrowRight":e.preventDefault(),this.seek(this.currentTime+10);break;case"ArrowUp":e.preventDefault(),this.setVolume(Math.min(1,this.volume+.1));break;case"ArrowDown":e.preventDefault(),this.setVolume(Math.max(0,this.volume-.1));break;case"KeyM":e.preventDefault(),this.toggleMute();break;case"KeyF":e.preventDefault(),this.toggleFullscreen();break}}showControls(){this.controlsVisible=!0,this.controlsContainer.style.opacity="1",this.container.style.cursor="default"}hideControls(){this.isPlaying&&(this.controlsVisible=!1,this.controlsContainer.style.opacity="0",this.container.style.cursor="none")}hideControlsDelayed(){this.controlsTimer&&clearTimeout(this.controlsTimer),this.controlsTimer=setTimeout(()=>{this.hideControls()},3e3)}play(){return l(this,null,function*(){if(this.participantControlsDisabled){console.log("🔒 Play blocked: Only host can control playback");return}try{yield this.streamingManager.play(),this.isHost&&(console.log("🎬 Host started playback - syncing with participants"),this.notifyPlaybackChange("play",this.currentTime),this.showHostAction("play"))}catch(e){console.error("❌ Play failed:",e),this.isHost&&this.showError(`Failed to start playback: ${e.message}`)}})}pause(){if(this.participantControlsDisabled){console.log("🔒 Pause blocked: Only host can control playback");return}this.streamingManager.pause(),this.isHost&&(console.log("🎬 Host paused playback - syncing with participants"),this.notifyPlaybackChange("pause",this.currentTime),this.showHostAction("pause"))}togglePlayPause(){if(this.participantControlsDisabled){console.log("🔒 Play/Pause blocked: Only host can control playback");return}this.isPlaying?this.pause():this.play()}seek(e){if(this.participantControlsDisabled){console.log("🔒 Seek blocked: Only host can control playback");return}const t=Math.max(0,Math.min(this.duration,e));this.streamingManager.seek(t),this.isHost&&(console.log(`🎬 Host seeked to ${this.formatTime(t)} - syncing with participants`),this.notifyPlaybackChange("seek",t),this.showHostAction("seek",t))}showHostAction(e,t=null){if(!this.isHost)return;const i=this.container.querySelector(".host-indicator");if(!i)return;const s=document.createElement("div");s.className="host-action-feedback";let n="";switch(e){case"play":n="▶️ Playing for all";break;case"pause":n="⏸️ Paused for all";break;case"seek":n=`⏩ Seeked to ${this.formatTime(t)}`;break}s.textContent=n,s.style.cssText=`
      position: absolute;
      top: -30px;
      right: 0;
      background: rgba(16, 185, 129, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
    `,i.style.position="relative",i.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},2e3)}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.videoElement.getAttribute("data-webrtc")==="true"?(this.videoElement.volume=this.volume,this.videoElement.muted=this.volume===0,console.log(`🔊 WebRTC volume set to: ${Math.round(this.volume*100)}%`)):(this.streamingManager.setVolume(this.volume),this.videoElement.muted=!1),this.updateVolumeControls()}toggleMute(){this.isMuted=!this.isMuted,this.videoElement.getAttribute("data-webrtc")==="true"?(this.videoElement.muted=this.isMuted,this.isMuted?(this.lastVolume=this.volume,this.videoElement.volume=0):this.videoElement.volume=this.lastVolume||this.volume,console.log(`🔊 WebRTC ${this.isMuted?"muted":"unmuted"}`)):this.videoElement.muted=this.isMuted,this.updateVolumeControls()}toggleFullscreen(){return l(this,null,function*(){if(this.isFullscreen)try{yield document.exitFullscreen()}catch(e){console.warn("⚠️ Exit fullscreen failed:",e)}else try{yield this.container.requestFullscreen()}catch(e){console.warn("⚠️ Fullscreen not supported:",e)}})}syncWithParticipants(){this.isHost&&(console.log("🔄 Syncing with participants"),this.showSyncFeedback(),this.notifyPlaybackChange("sync",this.currentTime,{isPlaying:this.isPlaying,volume:this.volume,duration:this.duration}))}showSyncFeedback(){const e=this.container.querySelector("#sync-btn");if(!e)return;const t=e.innerHTML;e.innerHTML=`
      <svg viewBox="0 0 24 24" width="20" height="20" class="sync-animation">
        <path fill="currentColor" d="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z" />
      </svg>
    `;const i=e.querySelector("svg");i&&(i.style.animation="spin 1s linear"),setTimeout(()=>{e.innerHTML=t,this.updateSyncButtonTooltip()},1e3)}updateSyncButtonTooltip(){const e=this.container.querySelector("#sync-btn");!e||!this.isHost||(e.title="Sync playback with all participants")}updatePlayPauseButton(){const e=this.container.querySelector(".play-icon"),t=this.container.querySelector(".pause-icon");this.isPlaying?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none")}updateVolumeControls(){const e=this.container.querySelector(".volume-icon"),t=this.container.querySelector(".mute-icon"),i=this.container.querySelector("#volume-fill"),s=this.container.querySelector("#volume-thumb");this.isMuted||this.volume===0?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none");const n=this.isMuted?0:this.volume*100;i.style.width=`${n}%`,s.style.left=`${n}%`}updateFullscreenButton(){const e=this.container.querySelector(".fullscreen-icon"),t=this.container.querySelector(".fullscreen-exit-icon");this.isFullscreen?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none")}updateTimeDisplay(){const e=this.container.querySelector(".current-time"),t=this.container.querySelector(".duration-time");e&&(e.textContent=this.formatTime(this.currentTime)),t&&(t.textContent=this.formatTime(this.duration))}updateProgressBar(){const e=this.container.querySelector("#progress-played"),t=this.container.querySelector("#progress-buffered"),i=this.container.querySelector("#progress-thumb");if(this.duration>0){const s=this.currentTime/this.duration*100;e.style.width=`${s}%`,i.style.left=`${s}%`}t.style.width=`${this.bufferedPercent}%`}updateBufferIndicator(e){const t=this.container.querySelector(".buffer-indicator");t&&(t.style.width=`${e.health}%`,e.health>80?t.style.backgroundColor="#10b981":e.health>40?t.style.backgroundColor="#f59e0b":t.style.backgroundColor="#ef4444")}updateSyncQualityIndicator(e){var n;if(this.isHost)return;const t=this.container.querySelector("#sync-quality"),i=this.container.querySelector(".sync-indicator"),s=this.container.querySelector(".sync-text");if(!(!t||!i||!e))if(e.isCalibrated){t.style.display="flex";let r="#6b7280",a="SYNC";if(e.drift)switch(e.drift.quality){case"excellent":r="#10b981",a="SYNC";break;case"good":r="#f59e0b",a="SYNC";break;case"fair":r="#ef4444",a="DRIFT";break;default:r="#6b7280",a="SYNC"}i.style.backgroundColor=r,s.textContent=a;const c=Math.round(e.networkLatency),d=e.drift?Math.round(e.drift.averageAccuracy):0;t.title=`Sync Quality: ${((n=e.drift)==null?void 0:n.quality)||"unknown"}
Latency: ${c}ms
Accuracy: ±${d}ms`}else t.style.display="none"}updateLoadingProgress(e){const t=this.container.querySelector("#loading-progress-fill"),i=this.container.querySelector("#loading-progress-text");t&&(t.style.width=`${e.progress*100}%`),i&&(i.textContent=`${Math.round(e.progress*100)}%`)}showLoadingOverlay(){const e=this.container.querySelector("#loading-overlay");e&&(e.style.display="flex")}hideLoadingOverlay(){const e=this.container.querySelector("#loading-overlay");e&&(e.style.display="none")}showBufferingIndicator(e){const t=this.container.querySelector("#buffering-overlay");t&&(t.style.display=e?"flex":"none")}showError(e){const t=this.container.querySelector("#error-overlay"),i=this.container.querySelector("#error-message");t&&i&&(i.textContent=e,t.style.display="flex")}hideError(){const e=this.container.querySelector("#error-overlay");e&&(e.style.display="none")}retry(){return l(this,null,function*(){this.hideError(),this.showLoadingOverlay();try{this.currentFile&&this.container&&(yield this.initializeWithFile(this.currentFile,this.container,this.isHost))}catch(e){this.showError("Retry failed: "+e.message)}})}notifyStateChange(){this.onStateChange&&this.onStateChange({isPlaying:this.isPlaying,currentTime:this.currentTime,duration:this.duration,volume:this.volume,isMuted:this.isMuted,bufferedPercent:this.bufferedPercent})}notifyPlaybackChange(e,t,i={}){var s;!this.isHost||!this.socketClient||this.socketClient.emit("movie-control",{action:e,movieState:S({currentTime:t,isPlaying:this.isPlaying,title:((s=this.currentFile)==null?void 0:s.name)||"Unknown Movie",duration:this.duration||0},i)})}updatePlayerState(){this.updatePlayPauseButton(),this.updateVolumeControls(),this.updateFullscreenButton(),this.updateTimeDisplay(),this.updateProgressBar()}getStats(){var e,t;return M(S({},this.streamingManager.getStats()),{isInitialized:this.isInitialized,isHost:this.isHost,fileName:((e=this.currentFile)==null?void 0:e.name)||null,fileSize:((t=this.currentFile)==null?void 0:t.size)||0})}waitForMetadata(e=5e3){return l(this,null,function*(){return new Promise(t=>{if(this.videoElement.duration&&!isNaN(this.videoElement.duration)){console.log("🎬 Metadata already loaded"),t();return}const i=setTimeout(()=>{console.log("⏰ Metadata loading timeout, continuing anyway..."),t()},e),s=()=>{console.log("🎬 Metadata loaded during wait"),clearTimeout(i),t()};this.videoElement.addEventListener("loadedmetadata",s,{once:!0}),this.videoElement.addEventListener("durationchange",s,{once:!0}),this.videoElement.addEventListener("loadeddata",s,{once:!0})})})}updateLoadingStatus(e){const t=this.container.querySelector(".loading-text");t&&(t.textContent=e)}formatBytes(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+i[s]}formatTime(e){if(isNaN(e))return"0:00";const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`}showError(e){const t=this.container.querySelector("#error-overlay"),i=this.container.querySelector("#error-message"),s=this.container.querySelector("#retry-btn");t&&i&&(i.textContent=e,t.style.display="flex",s&&(s.onclick=()=>{this.hideError(),this.currentFile&&(console.log("🔄 Retrying video initialization..."),this.initializeWithFile(this.currentFile,this.container,this.isHost))}),console.log("⚠️ Error displayed:",e))}hideError(){const e=this.container.querySelector("#error-overlay");e&&(e.style.display="none",console.log("✅ Error overlay hidden"))}showBufferingIndicator(e){const t=this.container.querySelector("#buffering-overlay");t&&(t.style.display=e?"flex":"none")}emit(e,t){const i=new CustomEvent(`videoplayer:${e}`,{detail:t});this.container.dispatchEvent(i)}escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}destroy(){this.streamingManager.stop(),this.syncManager&&this.syncManager.destroy(),this.stopParticipantTimer(),document.removeEventListener("keydown",this.handleKeyPress),this.controlsTimer&&clearTimeout(this.controlsTimer),this.container&&(this.container.innerHTML=""),console.log("🎬 Video player destroyed")}}const Rt=Object.freeze(Object.defineProperty({__proto__:null,VideoPlayer:we},Symbol.toStringTag,{value:"Module"}));class Bt{constructor(e){this.socketClient=e,this.root=null,this.participantList=new Pt(e),this.movieFileSelector=null,this.videoPlayer=null,this.peerManager=null,this.voiceActive=!1,this.participants=new Map,this.boundHandlers=!1,this.isHost=!1,this.selectedMovie=null,this.movieState="none",this.remoteHostVideoStream=null,this.remoteHostAudioStreams=[]}mount(e,t){var d,h,p;if(!e)return;this.root=e,this.isHost=((d=t==null?void 0:t.user)==null?void 0:d.isHost)||!1,console.log("🔍 RoomView host detection:",{initialData:t,user:t==null?void 0:t.user,isHost:this.isHost,socketId:(p=(h=this.socketClient)==null?void 0:h.socket)==null?void 0:p.id}),this.root.innerHTML=this.render(t);const i=this.root.querySelector("#participants-container");if(this.participantList.attach(i),t!=null&&t.participants){this.participantList.setParticipants(t.participants);for(const u of t.participants)u&&u.socketId&&this.participants.set(u.socketId,u)}this.updateMovieStage(),this.isHost&&(this.movieState==="selecting"||this.movieState==="none")&&this.initializeMovieFileSelector();const s=this.root.querySelector("#request-mic");s&&s.addEventListener("click",()=>l(this,null,function*(){s.disabled=!0,(yield E.requestMicrophonePermissions()).granted||alert("Microphone permission denied. You can enable it later from browser settings.");const y=yield E.listAudioInputDevices();console.log("🎙️ Devices:",y),s.disabled=!1})),this.peerManager=new ae(this.socketClient,()=>l(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(u){return console.warn("Microphone not available, using silent stream"),new(window.AudioContext||window.webkitAudioContext)().createMediaStreamDestination().stream}})),this.peerManager.setHost(this.isHost),this.peerManager.onRemoteTrack=(u,y)=>{try{const v=this.isHost===!0,T=this.getHostPeerId();if(!v&&(!!T&&u===T)){y&&y.getAudioTracks&&y.getAudioTracks().length>0&&(this.upsertHostAudioStream(y),this.combineAndAttachHostStreamsIfReady());return}let P=this.root.querySelector(`audio[data-peer="${u}"]`);P||(P=document.createElement("audio"),P.dataset.peer=u,P.autoplay=!0,P.playsInline=!0,this.root.appendChild(P)),P.srcObject=y}catch(v){console.error("Failed handling remote audio track:",v)}},this.peerManager.onRemoteVideoTrack=(u,y)=>{console.log(`🎥 Received video stream from peer ${u}`);const v=this.getHostPeerId(),T=!!v&&u===v;if(!this.isHost&&T){this.remoteHostVideoStream=y,this.combineAndAttachHostStreamsIfReady();return}this.handleRemoteVideoStream(u,y)},this.participantList.onVolumeChange=(u,y)=>{const v=this.getHostPeerId();if(!this.isHost&&u===v)return;const T=this.root.querySelector(`audio[data-peer="${u}"]`);T&&(T.volume=y)},this.bindRoomParticipantEvents(),this.bindMovieEvents();const n=this.root.querySelector("#toggle-voice");n&&n.addEventListener("click",()=>l(this,null,function*(){this.voiceActive?(this.stopVoice(),n.textContent="Start Voice"):(yield this.startVoice(),n.textContent="Stop Voice")})),this.populateMicDevices(),this.startVoice();const r=this.root.querySelector("#toggle-voice");r&&(r.textContent="Stop Voice",r.disabled=!1,r.onclick=()=>l(this,null,function*(){this.voiceActive&&(this.stopVoice(),r.textContent="Voice Stopped",r.disabled=!0)}));const a=this.root.querySelector("#mic-toggle"),c=this.root.querySelector("#apply-audio");a==null||a.addEventListener("click",()=>this.toggleMic(a)),c==null||c.addEventListener("click",()=>this.applyAudioSettings())}initializeMovieFileSelector(){if(console.log("🎬 Attempting to initialize MovieFileSelector:",{isHost:this.isHost,hasRoot:!!this.root}),!this.isHost){console.log("🚫 Not host, skipping file selector initialization");return}const e=this.root.querySelector("#movie-file-selector-container");if(console.log("🎬 File selector container found:",!!e),!e){console.error("❌ movie-file-selector-container not found in DOM");return}this.movieFileSelector=new Lt(this.socketClient,t=>this.handleMovieSelected(t)),this.movieFileSelector.mount(e),console.log("✅ Movie file selector initialized for host")}handleMovieSelected(e){return l(this,null,function*(){this.selectedMovie=e,this.movieState="loading",console.log("🎬 Movie selected:",e.name,e.size);try{this.updateMovieStage(),this.movieState="ready",this.updateMovieStage();const t=this.root.querySelector("#video-player-container");if(t){this.videoPlayer=new we(this.socketClient,s=>this.handleVideoStateChange(s)),yield this.videoPlayer.initializeWithFile(e.file,t,this.isHost),this.movieState="ready",console.log("✅ Video player initialized successfully"),yield this.waitForVideoMetadata(),this.isHost&&(yield this.startVideoStreaming());const i=this.getVideoMetadata(e);this.socketClient.emit("movie-control",{action:"start-streaming",movieState:i})}else throw new Error("Video player container not found")}catch(t){console.error("❌ Failed to initialize video player:",t),this.movieState="error",this.updateMovieStage(),alert(`Failed to load video: ${t.message}`)}})}updateMovieStage(){const e=this.root.querySelector("#movie-stage");if(e)switch(this.movieState){case"none":case"selecting":e.innerHTML=this.isHost?'<div id="movie-file-selector-container"></div>':this.renderWaitingForHost();break;case"loading":e.innerHTML=this.renderLoadingState();break;case"ready":case"playing":e.innerHTML=`
          <div class="video-player-wrapper">
            <div id="video-player-container"></div>
            ${this.isHost?this.renderHostControls():""}
          </div>
        `,this.bindMovieControls();break;case"error":e.innerHTML=this.renderErrorState(),this.bindMovieControls();break}}renderWaitingForHost(){return`
      <div class="waiting-for-host">
        <div class="waiting-content">
          <svg class="waiting-icon" viewBox="0 0 24 24" width="64" height="64">
            <path fill="currentColor" d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.5L17,15L15.5,17.5L11.5,15V7H12.5Z" />
          </svg>
          <h3>Waiting for Host</h3>
          <p>The host will select and start the movie when ready.</p>
        </div>
      </div>
    `}renderLoadingState(){var e,t,i;return`
      <div class="movie-loading">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <h3>Loading Movie...</h3>
          <p>Preparing ${this.escapeHtml(((e=this.selectedMovie)==null?void 0:e.name)||"video")} for streaming</p>
          <div class="loading-details">
            <div class="loading-stat">
              <span class="stat-label">Size:</span>
              <span class="stat-value">${this.formatFileSize(((t=this.selectedMovie)==null?void 0:t.size)||0)}</span>
            </div>
            <div class="loading-stat">
              <span class="stat-label">Format:</span>
              <span class="stat-value">${this.escapeHtml(((i=this.selectedMovie)==null?void 0:i.type)||"Unknown")}</span>
            </div>
          </div>
        </div>
      </div>
    `}renderHostControls(){return`
      <div class="host-movie-controls">
        <button class="btn btn-secondary btn-small" id="change-movie" title="Select different movie">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12C4,13.57 4.46,15.03 5.24,16.26L6.7,14.8C6.25,13.97 6,13 6,12A6,6 0 0,1 12,6M18.76,7.74L17.3,9.2C17.74,10.03 18,11 18,12A6,6 0 0,1 12,18V15L8,19L12,23V20A8,8 0 0,0 20,12C20,10.43 19.54,8.97 18.76,7.74Z" />
          </svg>
          Change Movie
        </button>
      </div>
    `}renderErrorState(){return`
      <div class="movie-error">
        <div class="error-content">
          <div class="error-icon">⚠️</div>
          <h3>Movie Loading Failed</h3>
          <p>There was an error loading the selected movie file.</p>
          <div class="error-actions">
            <button class="btn btn-primary" id="retry-movie">Try Again</button>
            <button class="btn btn-secondary" id="change-movie">Select Different Movie</button>
          </div>
        </div>
      </div>
    `}bindMovieControls(){const e=this.root.querySelector("#change-movie"),t=this.root.querySelector("#retry-movie");e==null||e.addEventListener("click",()=>this.changeMovie()),t==null||t.addEventListener("click",()=>this.retryMovie())}handleVideoStateChange(e){console.log("🎬 Video state changed:",e),e.isPlaying?this.movieState="playing":this.movieState==="playing"&&(this.movieState="ready"),this.emit("movie-state-change",{movieState:this.movieState,videoState:e,selectedMovie:this.selectedMovie})}changeMovie(){this.videoPlayer&&(this.videoPlayer.destroy(),this.videoPlayer=null),this.selectedMovie=null,this.movieState="selecting",this.updateMovieStage(),this.isHost&&this.initializeMovieFileSelector(),console.log("🔄 Movie selection reset")}retryMovie(){return l(this,null,function*(){if(!this.selectedMovie){this.changeMovie();return}console.log("🔄 Retrying movie initialization..."),this.videoPlayer&&(this.videoPlayer.destroy(),this.videoPlayer=null),yield this.handleMovieSelected(this.selectedMovie)})}formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+i[s]}unmount(){this.participantList&&this.participantList.destroy(),this.movieFileSelector&&this.movieFileSelector.destroy(),this.videoPlayer&&this.videoPlayer.destroy(),this.peerManager&&this.peerManager.destroy(),this.unbindRoomParticipantEvents(),this.root&&(this.root.innerHTML=""),this.root=null}populateMicDevices(){return l(this,null,function*(){const e=this.root.querySelector("#mic-device");if(!e)return;const{devices:t}=yield E.listAudioInputDevices();e.innerHTML="",(t||[]).forEach(i=>{const s=document.createElement("option");s.value=i.deviceId,s.textContent=i.label||"Microphone",e.appendChild(s)})})}toggleMic(e){return l(this,null,function*(){var r;const t=(r=this.peerManager)==null?void 0:r.currentLocalStream,i=t==null?void 0:t.getAudioTracks()[0];if(!i)return;const s=!i.enabled;i.enabled=s,e.textContent=s?"Mute Mic":"Unmute Mic";const n=!s;this.socketClient.emit("mic-toggle",{muted:n})})}applyAudioSettings(){return l(this,null,function*(){var r,a,c;const e=this.root.querySelector("#mic-device"),t=(r=this.root.querySelector("#aec"))==null?void 0:r.checked,i=(a=this.root.querySelector("#ns"))==null?void 0:a.checked,s=(c=this.root.querySelector("#agc"))==null?void 0:c.checked,n=(e==null?void 0:e.value)||void 0;try{const d=E.getAudioConstraints({echoCancellation:t,noiseSuppression:i,autoGainControl:s,deviceId:n}),h=yield navigator.mediaDevices.getUserMedia(d);yield this.peerManager.replaceLocalStream(h)}catch(d){alert("Failed to apply audio settings. Check permissions and try again.")}})}startVoice(){return l(this,null,function*(){var t;this.voiceActive=!0;const e=(t=this.socketClient.socket)==null?void 0:t.id;for(const[i]of this.participants.entries())if(!(!i||i===e))try{yield this.peerManager.callPeer(i)}catch(s){}})}stopVoice(){var e,t;this.voiceActive=!1,this.peerManager&&(this.peerManager.destroy(),this.peerManager=new ae(this.socketClient,()=>l(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(i){return new(window.AudioContext||window.webkitAudioContext)().createMediaStreamDestination().stream}})),this.peerManager.onRemoteTrack=(i,s)=>{const n=this.getHostPeerId(),r=!!n&&i===n;if(!this.isHost&&r){this.upsertHostAudioStream(s),this.combineAndAttachHostStreamsIfReady();return}let a=this.root.querySelector(`audio[data-peer="${i}"]`);a||(a=document.createElement("audio"),a.dataset.peer=i,a.autoplay=!0,a.playsInline=!0,this.root.appendChild(a)),a.srcObject=s}),(t=(e=this.root)==null?void 0:e.querySelectorAll("audio[data-peer]"))==null||t.forEach(i=>i.remove()),this.remoteHostVideoStream=null,this.remoteHostAudioStreams=[]}bindRoomParticipantEvents(){this.boundHandlers||(this._onJoined=({participant:e,participants:t})=>{if(t)for(const i of t)this.participants.set(i.socketId,i);else e&&(this.participants.set(e.socketId,e),this.voiceActive&&(this.peerManager.callPeer(e.socketId).catch(()=>{}),this.isHost&&this.peerManager.currentVideoStream&&this.peerManager.renegotiatePeer(e.socketId).catch(()=>{})))},this._onLeft=({participant:e,participants:t})=>{if(t){this.participants.clear();for(const i of t)this.participants.set(i.socketId,i)}else e&&(this.participants.delete(e.socketId),this.voiceActive&&this.peerManager.closePeer(e.socketId))},this._onDisconnected=this._onLeft,this.socketClient.on("participant-joined",this._onJoined),this.socketClient.on("participant-left",this._onLeft),this.socketClient.on("participant-disconnected",this._onDisconnected),this.boundHandlers=!0)}unbindRoomParticipantEvents(){this.boundHandlers&&(this.socketClient.off("participant-joined",this._onJoined),this.socketClient.off("participant-left",this._onLeft),this.socketClient.off("participant-disconnected",this._onDisconnected),this.boundHandlers=!1)}bindMovieEvents(){this.movieEventsbound||(this.socketClient.on("movie-sync",e=>{console.log("🎬 Received movie sync from host:",e),this.handleMovieSync(e)}),this.socketClient.on("movie-control-error",e=>{console.error("❌ Movie control error:",e),alert(`Movie error: ${e.error}`)}),this.movieEventsbound=!0)}waitForVideoMetadata(e=5e3){return l(this,null,function*(){if(!this.videoPlayer||!this.videoPlayer.videoElement){console.warn("⚠️ No video player available for metadata loading");return}const t=this.videoPlayer.videoElement;if(t.duration&&!isNaN(t.duration)){console.log("✅ Video metadata already loaded");return}return console.log("⏳ Waiting for video metadata to load..."),new Promise(i=>{const s=setTimeout(()=>{console.warn("⚠️ Video metadata loading timeout, continuing anyway..."),i()},e),n=()=>{console.log("✅ Video metadata loaded successfully"),clearTimeout(s),t.removeEventListener("loadedmetadata",n),t.removeEventListener("durationchange",n),t.removeEventListener("loadeddata",n),i()};t.addEventListener("loadedmetadata",n),t.addEventListener("durationchange",n),t.addEventListener("loadeddata",n)})})}getVideoMetadata(e){var n,r,a,c;const t=(n=this.videoPlayer)==null?void 0:n.videoElement,i=(a=(r=this.videoPlayer)==null?void 0:r.streamingManager)==null?void 0:a.getStats(),s={title:e.name,type:e.type,size:e.size,duration:(t==null?void 0:t.duration)||0,width:(t==null?void 0:t.videoWidth)||0,height:(t==null?void 0:t.videoHeight)||0,totalChunks:(i==null?void 0:i.totalChunks)||0,chunkSize:(i==null?void 0:i.chunkSize)||0,mimeType:(i==null?void 0:i.mimeType)||e.type,currentTime:(t==null?void 0:t.currentTime)||0,isPlaying:!1,hasVideo:!!(t!=null&&t.videoWidth&&(t!=null&&t.videoHeight)),hasAudio:!!(t!=null&&t.webkitAudioDecodedByteCount||(c=t==null?void 0:t.audioTracks)!=null&&c.length),timestamp:Date.now()};return console.log("📊 Generated video metadata for participants:",s),s}startVideoStreaming(){return l(this,null,function*(){var e,t,i,s,n;if(!this.isHost){console.warn("⚠️ Cannot start video streaming: not host");return}if(!this.videoPlayer||!this.videoPlayer.videoElement){console.warn("⚠️ Cannot start video streaming: video player not ready");return}try{console.log("🎥 Starting WebRTC video streaming..."),console.log("🔍 Video element state:",{readyState:this.videoPlayer.videoElement.readyState,videoWidth:this.videoPlayer.videoElement.videoWidth,videoHeight:this.videoPlayer.videoElement.videoHeight,currentSrc:this.videoPlayer.videoElement.currentSrc,paused:this.videoPlayer.videoElement.paused});const r=E.checkWebRTCSupport();if(console.log("🔍 WebRTC support check:",r),!r.supported)throw new Error(`Browser missing WebRTC features: ${Object.entries(r).filter(([h,p])=>!p&&h!=="supported").map(([h])=>h).join(", ")}`);if(typeof this.videoPlayer.videoElement.captureStream!="function")throw new Error("Video element does not support captureStream - try a different browser");this.videoPlayer.videoElement.readyState<2&&(console.log("🎥 Waiting for video metadata to load..."),yield new Promise((h,p)=>{const u=setTimeout(()=>{p(new Error("Video metadata loading timeout"))},5e3);this.videoPlayer.videoElement.addEventListener("loadedmetadata",()=>{clearTimeout(u),h()},{once:!0})}));const a=this.peerManager.peerIdToPc.size;console.log(`🔍 Active peer connections: ${a}`),a===0&&console.warn("⚠️ No active peer connections - participants may need to start voice chat first"),console.log("🔊 Host video audio check before streaming:",{muted:this.videoPlayer.videoElement.muted,volume:this.videoPlayer.videoElement.volume});const c=this.videoPlayer.videoElement.muted;this.videoPlayer.videoElement.muted=!1,this.videoPlayer.videoElement.volume=1,console.log("🎥 Calling peerManager.startVideoStreaming...");const d=yield this.peerManager.startVideoStreaming(this.videoPlayer.videoElement,{frameRate:30,quality:"high",includeAudio:!0});if(this.videoPlayer.videoElement.muted=c,console.log("🎥 Video streaming result:",d),d.success)console.log("✅ Video streaming started successfully"),this.showVideoStreamingStatus(!0),this.showTemporaryMessage("🎥 Video streaming to participants started!","success");else throw new Error(d.error)}catch(r){console.error("❌ Failed to start video streaming:",r);const a=`Video streaming failed: ${r.message}. Audio and sync will still work.`;this.showTemporaryMessage(a,"warning"),console.log("🔍 Technical details:",{hasVideoPlayer:!!this.videoPlayer,hasVideoElement:!!((e=this.videoPlayer)!=null&&e.videoElement),videoElementReady:(i=(t=this.videoPlayer)==null?void 0:t.videoElement)==null?void 0:i.readyState,peerConnections:((n=(s=this.peerManager)==null?void 0:s.peerIdToPc)==null?void 0:n.size)||0,isHost:this.isHost})}})}stopVideoStreaming(){return l(this,null,function*(){try{yield this.peerManager.stopVideoStreaming(),this.showVideoStreamingStatus(!1),console.log("🎥 Video streaming stopped")}catch(e){console.error("❌ Failed to stop video streaming:",e)}})}handleRemoteVideoStream(e,t){try{if(console.log(`🎥 Setting up remote video stream from peer ${e}`,{streamId:t.id,videoTracks:t.getVideoTracks().length,audioTracks:t.getAudioTracks().length}),t.getVideoTracks().forEach((s,n)=>{console.log(`🎥 Video track ${n}:`,{id:s.id,label:s.label,enabled:s.enabled,readyState:s.readyState})}),t.getAudioTracks().forEach((s,n)=>{console.log(`🔊 Audio track ${n}:`,{id:s.id,label:s.label,enabled:s.enabled,readyState:s.readyState})}),!this.videoPlayer||!this.videoPlayer.videoElement){console.error("❌ Video player not ready for remote stream");return}console.log("🔍 Video element before stream:",{src:this.videoPlayer.videoElement.src,srcObject:this.videoPlayer.videoElement.srcObject,readyState:this.videoPlayer.videoElement.readyState}),this.videoPlayer.videoElement.srcObject=t,this.videoPlayer.videoElement.autoplay=!0,this.videoPlayer.videoElement.playsInline=!0,this.videoPlayer.videoElement.muted=!1,this.videoPlayer.videoElement.volume=1,this.videoPlayer.videoElement.setAttribute("data-webrtc","true"),this.videoPlayer.videoElement.addEventListener("loadedmetadata",()=>{console.log("🎥 Remote video metadata loaded:",{videoWidth:this.videoPlayer.videoElement.videoWidth,videoHeight:this.videoPlayer.videoElement.videoHeight,duration:this.videoPlayer.videoElement.duration,muted:this.videoPlayer.videoElement.muted,volume:this.videoPlayer.videoElement.volume}),t.getAudioTracks().length>0?console.log("🔊 Video stream has audio tracks - should have sound"):console.warn("⚠️ Video stream has no audio tracks - no sound expected")},{once:!0}),this.videoPlayer.videoElement.addEventListener("canplay",()=>{console.log("🎥 Remote video can play"),console.log("🔊 Final audio check:",{muted:this.videoPlayer.videoElement.muted,volume:this.videoPlayer.videoElement.volume,audioTracks:t.getAudioTracks().length}),this.videoPlayer.hideLoadingOverlay();const s=t.getAudioTracks().length>0?" with sound":" (no audio)";this.showTemporaryMessage(`🎥 Video stream connected${s}!`,"success")},{once:!0}),this.videoPlayer.videoElement.addEventListener("error",s=>{console.error("❌ Remote video error:",s),this.showTemporaryMessage("Video playback error","error")},{once:!0});const i=this.videoPlayer.duration;this.videoPlayer.stopParticipantTimer(),i&&i>0&&(console.log(`🕐 Preserving original duration: ${i}s`),this.videoPlayer.videoElement.addEventListener("loadedmetadata",()=>{Object.defineProperty(this.videoPlayer.videoElement,"duration",{value:i,writable:!1,configurable:!0}),this.videoPlayer.duration=i,this.videoPlayer.updateTimeDisplay(),console.log("🕐 Duration restored for WebRTC stream")},{once:!0})),console.log("✅ Remote video stream setup completed")}catch(i){console.error("❌ Failed to handle remote video stream:",i),this.showTemporaryMessage("Video stream connection failed","error")}}getHostPeerId(){for(const[e,t]of this.participants.entries())if(t&&t.isHost)return e;return null}upsertHostAudioStream(e){this.remoteHostAudioStreams=this.remoteHostAudioStreams.filter(i=>i&&i.getTracks().some(s=>s.readyState!=="ended")),this.remoteHostAudioStreams.some(i=>i.id===e.id)||this.remoteHostAudioStreams.push(e)}combineAndAttachHostStreamsIfReady(){var r,a;if(this.isHost||!this.videoPlayer||!this.videoPlayer.videoElement)return;this.videoPlayer&&typeof this.videoPlayer.exitVirtualMode=="function"&&this.videoPlayer.exitVirtualMode();const e=this.remoteHostVideoStream,t=new MediaStream;if(e){const c=e.getVideoTracks();c.length>0&&t.addTrack(c[0])}if(e){const c=e.getAudioTracks();for(const d of c)t.addTrack(d)}for(const c of this.remoteHostAudioStreams)c.getAudioTracks().forEach(d=>t.addTrack(d));const i=this.videoPlayer.videoElement;i.srcObject=t,i.autoplay=!0,i.playsInline=!0,i.setAttribute("data-webrtc","true");const s=this.videoPlayer.duration;if(s&&s>0){const c=()=>{try{Object.defineProperty(i,"duration",{value:s,writable:!1,configurable:!0}),this.videoPlayer.duration=s,this.videoPlayer.updateTimeDisplay()}catch(d){}};i.readyState>=1?c():i.addEventListener("loadedmetadata",c,{once:!0})}const n=this.getHostPeerId();n&&((a=(r=this.root)==null?void 0:r.querySelectorAll(`audio[data-peer="${n}"]`))==null||a.forEach(c=>c.remove())),this.videoPlayer.hideLoadingOverlay(),console.log("✅ Host video+audio attached to participant VideoPlayer element")}showVideoStreamingStatus(e){const t=this.root.querySelector(".host-indicator");if(t&&this.isHost){const i=t.querySelector(".stream-status");if(i&&i.remove(),e){const s=document.createElement("div");s.className="stream-status",s.innerHTML="🎥 LIVE",s.style.cssText=`
          font-size: 8px;
          color: #ef4444;
          font-weight: 700;
          margin-top: 2px;
        `,t.appendChild(s)}}}showTemporaryMessage(e,t="info"){const i=document.createElement("div");i.className=`temp-message temp-message-${t}`,i.textContent=e,i.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      background: ${t==="success"?"#10b981":t==="warning"?"#f59e0b":t==="error"?"#ef4444":"#3b82f6"};
    `,document.body.appendChild(i),setTimeout(()=>{i.parentNode&&(i.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300))},4e3)}handleMovieSync(e){return l(this,null,function*(){const{action:t,movieState:i}=e;switch(console.log("🎬 Processing movie sync:",{action:t,movieState:i}),t){case"start-streaming":yield this.handleHostStartedStreaming(i);break;case"play":this.handleHostPlay(i);break;case"pause":this.handleHostPause(i);break;case"seek":this.handleHostSeek(i);break;case"stop-streaming":this.handleHostStoppedStreaming();break;case"sync":yield this.handleHostStartedStreaming(i),i&&typeof i.currentTime=="number"&&this.videoPlayer&&this.videoPlayer.videoElement&&(this.videoPlayer.videoElement.currentTime=i.currentTime,i.isPlaying?this.videoPlayer.videoElement.play():this.videoPlayer.videoElement.pause());break;default:console.warn("Unknown movie sync action:",t)}})}handleHostStartedStreaming(e){return l(this,null,function*(){if(this.isHost)return;console.log("🎬 Host started streaming, transitioning from waiting screen to video player"),this.selectedMovie={name:e.title||"Unknown Movie",type:e.type||"video/mp4",size:e.size||0},this.movieState="ready",this.updateMovieStage();const t=this.root.querySelector("#video-player-container");if(t)try{const{VideoPlayer:i}=yield Tt(()=>l(this,null,function*(){const{VideoPlayer:s}=yield Promise.resolve().then(()=>Rt);return{VideoPlayer:s}}),void 0);this.videoPlayer=new i(this.socketClient,s=>this.handleVideoStateChange(s)),this.videoPlayer.initializeAsParticipant(t,e),console.log("✅ Participant video player initialized")}catch(i){console.error("❌ Failed to initialize participant video player:",i),this.movieState="error",this.updateMovieStage()}})}handleHostPlay(e){var i;if(!this.videoPlayer)return;console.log("▶️ Host started playback");const t=M(S({},e),{title:e.title||((i=this.selectedMovie)==null?void 0:i.name)||"Unknown Movie"});this.videoPlayer.syncWithHost("play",t)}handleHostPause(e){var i;if(!this.videoPlayer)return;console.log("⏸️ Host paused playback");const t=M(S({},e),{title:e.title||((i=this.selectedMovie)==null?void 0:i.name)||"Unknown Movie"});this.videoPlayer.syncWithHost("pause",t)}handleHostSeek(e){var i;if(!this.videoPlayer)return;console.log("⏩ Host seeked to:",e.currentTime);const t=M(S({},e),{title:e.title||((i=this.selectedMovie)==null?void 0:i.name)||"Unknown Movie"});this.videoPlayer.syncWithHost("seek",t)}handleHostStoppedStreaming(){console.log("⏹️ Host stopped streaming"),this.isHost&&this.stopVideoStreaming(),this.selectedMovie=null,this.movieState="none",this.videoPlayer&&(this.videoPlayer.destroy(),this.videoPlayer=null),this.updateMovieStage()}renderMovieStage(){return this.movieState==="none"&&(this.movieState="selecting"),'<div class="movie-stage" id="movie-stage"></div>'}emit(e,t){if(this.root){const i=new CustomEvent(`roomview:${e}`,{detail:t});this.root.dispatchEvent(i)}}render(e){var s;const t=(e==null?void 0:e.roomCode)||"######",i=((s=e==null?void 0:e.room)==null?void 0:s.title)||"BeeMoo Room";return`
      <section class="room-shell" aria-label="Room">
        <header class="room-header">
          <h2 class="room-title">${this.escapeHtml(i)}</h2>
          <div class="room-meta">
            <span class="room-code-inline" title="Room Code">${this.escapeHtml(t)}</span>
            <button id="request-mic" class="btn btn-secondary btn-small" style="margin-left:8px">Enable Mic</button>
            <button id="toggle-voice" class="btn btn-primary btn-small" style="margin-left:8px">Start Voice</button>
          </div>
        </header>
        <div class="room-content">
          <aside class="room-sidebar" aria-label="Participants">
            <div id="participants-container"></div>
          </aside>
          <main class="room-main" aria-label="Stage">
            ${this.renderMovieStage()}
            <div class="audio-controls" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
              <button id="mic-toggle" class="btn btn-secondary btn-small">Mute Mic</button>
              <select id="mic-device" class="form-input" style="max-width:260px;"></select>
              <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="aec" checked /> Echo Cancellation
              </label>
              <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="ns" checked /> Noise Suppression
              </label>
              <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="agc" checked /> Auto Gain
              </label>
              <button id="apply-audio" class="btn btn-primary btn-small">Apply</button>
            </div>
          </main>
        </div>
      </section>
    `}escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}}class _t{constructor(){this.appElement=document.getElementById("app"),this.socketClient=new St,this.initialized=!1,this.currentView="landing",this.currentRoom=null,this.roomCreation=new wt(this.socketClient,e=>this.handleRoomCreated(e)),this.roomJoining=new kt(this.socketClient,e=>this.handleRoomJoined(e)),this.roomView=new Bt(this.socketClient)}init(){if(this.initialized){console.warn("App already initialized");return}const e=this.getPersistedRoomSession();if(e&&e.roomCode&&e.username){this.connectToServer(),this.socketClient.on("room-joined",t=>{this.currentRoom=t,this.navigateToRoom(t)}),this.socketClient.on("join-room-error",t=>{this.clearRoomSession(),this.render()}),this.socketClient.on("connect",()=>{this.socketClient.emit("join-room",{roomCode:e.roomCode,username:e.username})}),this.renderLoading("Rejoining room..."),this.initialized=!0;return}this.render(),this.setupEventListeners(),this.connectToServer(),this.initialized=!0,console.log("✅ BeeMoo app initialized successfully")}getPersistedRoomSession(){try{return JSON.parse(localStorage.getItem("beemoo-room-session"))}catch(e){return null}}renderLoading(e){this.appElement&&(this.appElement.innerHTML=`<div class="beemoo-app"><div class="loading-overlay" style="display:flex;align-items:center;justify-content:center;height:100vh;"><div class="loading-content"><div class="loading-spinner"></div><div class="loading-text">${e||"Loading..."}</div></div></div></div>`)}render(){if(!this.appElement){console.error("App element not found");return}this.appElement.innerHTML=`
      <div class="beemoo-app">
        <header role="banner" class="main-header">
          <div class="header-content">
            <div class="brand-row">
              <h1 class="logo">🎬 BeeMoo</h1>
              <button id="nav-toggle" class="nav-toggle" aria-label="Open menu" aria-controls="main-nav" aria-expanded="false">
                <span class="nav-toggle-bar" aria-hidden="true"></span>
                <span class="sr-only">Menu</span>
              </button>
            </div>
            <p class="tagline">Movie Party Meetings Platform</p>
            
          </div>
          <nav id="main-nav" class="main-nav" aria-label="Primary">
            <ul>
              <li><a href="#" id="nav-create">Create Room</a></li>
              <li><a href="#" id="nav-join">Join Room</a></li>
              <li><a href="#features" id="nav-features">Features</a></li>
            </ul>
          </nav>
        </header>

        <main id="main-content" role="main" class="landing-main">
          <section class="hero-section" aria-labelledby="hero-title">
            <h2 id="hero-title" class="hero-title">Join or Create a Movie Party</h2>
            <p class="hero-description">
              Watch movies together with friends! Create a room to host, or join an existing room with a code.
            </p>
          </section>

          <section class="action-section" aria-label="Room Actions">
            <div class="action-container">
              <div class="action-card create-room-card">
                <div class="card-icon">🏠</div>
                <h3>Create Room</h3>
                <p>Start a new movie party and invite friends to join</p>
                <button 
                  id="create-room-btn" 
                  class="btn btn-primary btn-large"
                  aria-describedby="create-room-help"
                >
                  Create New Room
                </button>
                <small id="create-room-help" class="help-text">
                  You'll be the host and control movie playback
                </small>
              </div>

              <div class="action-card join-room-card">
                <div class="card-icon">🚪</div>
                <h3>Join Room</h3>
                <p>Enter a room code to join an existing movie party</p>
                <button 
                  id="join-room-btn" 
                  class="btn btn-secondary btn-large"
                  aria-describedby="join-room-help"
                >
                  Join Existing Room
                </button>
                <small id="join-room-help" class="help-text">
                  Get the room code from your host
                </small>
              </div>
            </div>
          </section>

          <section class="features-section" aria-labelledby="features-title">
            <h3 id="features-title" class="features-title">What You Can Do</h3>
            <div class="features-grid">
              <div class="feature-item">
                <span class="feature-icon">🎬</span>
                <h4>Watch Together</h4>
                <p>Stream movies from your device with perfect sync</p>
              </div>
              <div class="feature-item">
                <span class="feature-icon">🎤</span>
                <h4>Voice Chat</h4>
                <p>Talk with friends during the movie</p>
              </div>
              <div class="feature-item">
                <span class="feature-icon">💬</span>
                <h4>Text Chat</h4>
                <p>Send messages without interrupting</p>
              </div>
              <div class="feature-item">
                <span class="feature-icon">📱</span>
                <h4>Mobile Ready</h4>
                <p>Works perfectly on any device</p>
              </div>
            </div>
          </section>

          
        </main>

        <footer role="contentinfo" class="main-footer">
          <p>&copy; 2025 BeeMoo - Movie Party Meetings Platform</p>
        </footer>
      </div>
    `}connectToServer(){this.socketClient.connect()}setupEventListeners(){const e=document.getElementById("create-room-btn"),t=document.getElementById("join-room-btn");e&&e.addEventListener("click",()=>this.handleCreateRoom()),t&&t.addEventListener("click",()=>this.handleJoinRoom());const i=document.getElementById("nav-toggle"),s=document.querySelector(".main-header"),n=document.getElementById("main-nav");if(i&&s&&n){const r=()=>{s.classList.remove("nav-open"),i.setAttribute("aria-expanded","false")},a=()=>{s.classList.add("nav-open"),i.setAttribute("aria-expanded","true")},c=()=>{s.classList.contains("nav-open")?r():a()};i.addEventListener("click",d=>{d.preventDefault(),c()}),document.addEventListener("keydown",d=>{d.key==="Escape"&&r()}),n.addEventListener("click",d=>{d.target.tagName==="A"&&r()})}setTimeout(()=>{this.socketClient.isConnected&&(console.log("🏓 Testing WebSocket connection..."),this.socketClient.emit("ping",{message:"Hello from BeeMoo client!"}))},2e3)}handleCreateRoom(){console.log("🏠 Create room clicked"),this.roomCreation.show()}handleJoinRoom(){console.log("🚪 Join room clicked"),this.roomJoining.show()}handleRoomCreated(e){console.log("🎉 Room created successfully:",e),this.currentRoom=e,this.persistRoomSession(e),this.navigateToRoom(e)}handleRoomJoined(e){console.log("🎉 Room joined successfully:",e),this.currentRoom=e,this.persistRoomSession(e),this.navigateToRoom(e)}persistRoomSession(e){var t,i;try{const s={roomCode:e.roomCode,username:(t=e.user)==null?void 0:t.username,isHost:!!((i=e.user)!=null&&i.isHost)};localStorage.setItem("beemoo-room-session",JSON.stringify(s))}catch(s){}}clearRoomSession(){try{localStorage.removeItem("beemoo-room-session")}catch(e){}}navigateToRoom(e){if(this.currentView="room",this.appElement){this.appElement.innerHTML="";const t=document.createElement("div");this.appElement.appendChild(t);const i=Array.isArray(e.participants)&&e.participants.length>0?e.participants:e.user?[e.user]:[];this.roomView.mount(t,{roomCode:e.roomCode,room:e.room,user:e.user,participants:i})}}static getVersion(){return"1.0.0"}}document.addEventListener("DOMContentLoaded",()=>{console.log("🎬 BeeMoo - Movie Party Meetings Platform"),new _t().init()});
//# sourceMappingURL=main-BDySo0sl.js.map
